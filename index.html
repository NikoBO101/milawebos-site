<!doctype html>
<html lang="uk" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="app-version" content="1.6.0" />
  <title>MilaWEBOS CRM</title>

  <!-- Базові стилі (легкі, щоб усе було охайно до застосування патчів) -->
  <style>
    :root{
      --bg:#0f1426; --card:#141a33; --text:#e7ecff; --muted:#a9b3d9;
      --border:#262c4d; --input:#0f1530; --pill:#1a2140;
    }
    [data-theme="light"]{
      --bg:#f6f8ff; --card:#fff; --text:#1b2340; --muted:#5a6590;
      --border:#d8def4; --input:#eef2ff; --pill:#eef2ff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .container{max-width:1100px;margin:18px auto;padding:0 14px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .dot{width:10px;height:10px;border-radius:50%;background:#7cff9f;box-shadow:0 0 0 4px rgba(124,255,159,.15)}
    h1{font-size:20px;margin:0}
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .tabs{display:flex;gap:10px;margin-left:auto}
    .tabs button{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:999px;padding:8px 12px;cursor:pointer}
    .tabs button.active{outline:2px solid #4b64ff}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{display:none}.section.active{display:block}
    input,select,textarea{width:100%;background:var(--input);border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)}
    label{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
    .row{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
    .btn-secondary{background:#0f1530}
    #toast{position:fixed;right:16px;bottom:16px;background:#1a2140;border:1px solid var(--border);border-radius:10px;padding:8px 12px}
    .hidden{display:none!important}
  </style>

  <!-- Chart.js потрібен статистиці та частині патчів -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Вбудований блок для персист-патчів (аплікація його читає) -->
  <script id="applied-patches" type="application/json">{"applied":[]}</script>
</head>
<body>
  <div class="container">
    <header>
      <span class="dot"></span>
      <h1 id="appTitle">MilaWEBOS CRM</h1>
      <span class="pill" id="currentVersionWrap">версія: <b id="currentVersion">v1.6.0</b></span>
      <div class="tabs">
        <button id="tabForm" class="active">Переглянути ліди</button>
        <button id="tabSettings">Налаштування</button>
        <button id="tabAdvanced">Розширені функції</button>
        <button id="themeToggleBtn">Тема</button>
      </div>
    </header>

    <!-- СЕКЦІЯ: Форма/Ліди -->
    <section id="formSection" class="section active">
      <div class="grid">
        <div class="card" id="crmOptionsCard">
          <h2>Опції CRM</h2>
          <div class="row" style="flex-wrap:wrap;gap:6px">
            <!-- Кнопки додаються патчами; залишимо базові-заглушки -->
            <button class="btn" id="bulkInProgressBtn">Масово: «В обробці»</button>
          </div>
        </div>
        <div class="card">
          <h2>Пошук</h2>
          <input id="searchInput" placeholder="Пошук по імені/телефону/тегах" />
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Новий лід</h2>
        <form id="leadForm" class="grid">
          <div>
            <label>Імʼя</label>
            <input id="name" placeholder="Імʼя" />
          </div>
          <div>
            <label>Телефон</label>
            <input id="phone" placeholder="+380..." />
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="email@example.com" />
          </div>
          <div>
            <label>Статус</label>
            <select id="status">
              <option>Новий</option><option>В обробці</option>
              <option>Закритий</option><option>Відхилений</option>
            </select>
          </div>
          <div style="grid-column:1 / -1">
            <label>Теги</label>
            <input id="tags" placeholder="facebook, гарячий" />
          </div>
          <div style="grid-column:1 / -1">
            <label>Коментар</label>
            <textarea id="comment" rows="3"></textarea>
          </div>
          <div style="grid-column:1 / -1">
            <button class="btn" type="submit">Відправити</button>
          </div>
        </form>
      </div>

      <div class="card table-wrap" style="margin-top:12px">
        <h2>Ліди</h2>
        <table id="leadsTable">
          <thead>
            <tr><th></th><th>ID</th><th>Імʼя</th><th>Телефон</th><th>Email</th><th>Статус</th><th>Теги</th><th>Коментар</th><th>Дії</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- СЕКЦІЯ: Налаштування -->
    <section id="settingsSection" class="section">
      <div class="card">
        <h2>Менеджер оновлень (.mmur)</h2>
        <div class="row" style="flex-wrap:wrap">
          <button class="btn" id="umPick">Вибрати папку</button>
          <button class="btn" id="umScan">Сканувати</button>
          <button class="btn btn-secondary" id="umInstall" disabled>Встановити вибране</button>
        </div>
        <div id="umTree" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Онлайн-оновлення</h2>
        <div class="grid">
          <div>
            <label>URL індексу</label>
            <input id="updIndexUrl" placeholder="https://<твій_нік>.github.io/milawebos-site/updates/index.json" />
          </div>
          <div class="row" style="align-items:end">
            <button class="btn" id="updTestBtn">Перевірити з’єднання</button>
            <button class="btn" id="updFetchBtn">Завантажити список</button>
            <button class="btn btn-secondary" id="updInstallLatestBtn" disabled>Встановити останнє</button>
          </div>
        </div>
        <div id="updList" class="card" style="margin-top:10px"></div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="card">
          <h2>Інше</h2>
          <button class="btn" id="clearDataBtn">Очистити локальні дані</button>
          <button class="btn" id="startTrainingBtn">Навчання (курс)</button>
        </div>
        <div class="card">
          <h2>Бекап</h2>
          <button class="btn" id="backupBtn">Зробити бекап</button>
          <input id="restoreFile" type="file" accept=".json" class="hidden" />
          <button class="btn btn-secondary" id="restoreBtn">Відновити з файлу</button>
        </div>
      </div>
    </section>

    <!-- СЕКЦІЯ: Розширені -->
    <section id="advancedFeaturesSection" class="section">
      <div class="grid">
        <div class="card">
          <h2>Статистика</h2>
          <canvas id="chartStatusPie" height="140"></canvas>
        </div>
        <div class="card">
          <h2>Динаміка по днях</h2>
          <canvas id="chartByDay" height="140"></canvas>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden">OK</div>

  <script>
    // ---------------- Навігація по секціях
    const sections = {
      tabForm: 'formSection',
      tabSettings: 'settingsSection',
      tabAdvanced: 'advancedFeaturesSection'
    };
    Object.keys(sections).forEach(btnId=>{
      const btn=document.getElementById(btnId);
      btn?.addEventListener('click', ()=>{
        document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(sections[btnId])?.classList.add('active');
      });
    });

    // ---------------- Тема (light/dark)
    const themeBtn=document.getElementById('themeToggleBtn');
    const savedTheme=localStorage.getItem('theme')||'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeBtn?.addEventListener('click', ()=>{
      const cur=document.documentElement.getAttribute('data-theme');
      const next=cur==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    // ---------------- Реєстрація Service Worker (офлайн)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }

    // ---------------- Примітивна логіка для лід-форми/таблиці (до патчів)
    const toast = (t)=>{ const el=document.getElementById('toast'); el.textContent=t; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),2000); };
    const leadsKey='leads';
    function loadLeads(){ try{ return JSON.parse(localStorage.getItem(leadsKey)||'[]'); }catch(e){ return []; } }
    function saveLeads(arr){ localStorage.setItem(leadsKey, JSON.stringify(arr)); }
    function renderTable(){
      const tb=document.querySelector('#leadsTable tbody');
      const leads=loadLeads();
      tb.innerHTML='';
      leads.forEach(l=>{
        const tr=document.createElement('tr');
        tr.innerHTML = \`
          <td><input type="checkbox" class="sel" data-id="\${l.id}"></td>
          <td>\${l.id}</td><td>\${l.name||''}</td><td>\${l.phone||''}</td>
          <td>\${l.email||''}</td><td>\${l.status||''}</td>
          <td>\${l.tags||''}</td><td>\${l.comment||''}</td><td></td>\`;
        tb.appendChild(tr);
      });
    }
    document.getElementById('leadForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const leads=loadLeads();
      const id = Date.now();
      const get=v=>document.getElementById(v).value.trim();
      leads.push({id, name:get('name'), phone:get('phone'), email:get('email'),
                  status:document.getElementById('status').value, tags:get('tags'), comment:get('comment'),
                  date: new Date().toLocaleDateString('uk-UA')});
      saveLeads(leads); renderTable(); toast('Лід додано');
      e.target.reset();
    });
    document.getElementById('bulkInProgressBtn')?.addEventListener('click', ()=>{
      const leads=loadLeads();
      document.querySelectorAll('#leadsTable tbody .sel:checked').forEach(cb=>{
        const id=Number(cb.dataset.id);
        const i=leads.findIndex(l=>l.id===id);
        if(i>-1) leads[i].status='В обробці';
      });
      saveLeads(leads); renderTable(); toast('Статус оновлено');
    });
    renderTable();

    // ---------------- Відновлення/застосування патчів
    (function applyPersistedPatches(){
      // 1) з localStorage
      try{
        const arr = JSON.parse(localStorage.getItem('appliedPatches')||'[]');
        arr.forEach(p=>{
          if(p.patch?.css){ const s=document.createElement('style'); s.textContent=p.patch.css; document.head.appendChild(s); }
          if(p.patch?.js){ try{ (new Function(p.patch.js))(); }catch(e){} }
          if(p.patch?.title){ document.getElementById('appTitle').textContent=p.patch.title; document.title=p.patch.title; }
          if(p.version){ document.querySelector('meta[name="app-version"]').content=p.version;
            document.getElementById('currentVersion').textContent='v'+p.version; }
        });
      }catch(e){}
      // 2) з вбудованого <script id="applied-patches">
      try{
        const ap = document.getElementById('applied-patches');
        const data = JSON.parse(ap.textContent||'{}');
        (data.applied||[]).forEach(p=>{
          if(p.patch?.css){ const s=document.createElement('style'); s.textContent=p.patch.css; document.head.appendChild(s); }
          if(p.patch?.js){ try{ (new Function(p.patch.js))(); }catch(e){} }
        });
        if(data.versionPinned){
          document.querySelector('meta[name="app-version"]').content=data.versionPinned;
          document.getElementById('currentVersion').textContent='v'+data.versionPinned;
        }
      }catch(e){}
    })();

    // ---------------- Простий Online-оновлювач (з UI у налаштуваннях)
    (function onlineUpdates(){
      const urlInput=document.getElementById('updIndexUrl');
      const testBtn=document.getElementById('updTestBtn');
      const fetchBtn=document.getElementById('updFetchBtn');
      const installBtn=document.getElementById('updInstallLatestBtn');
      const listBox=document.getElementById('updList');
      const key='updatesIndexURL';
      urlInput.value = localStorage.getItem(key) || '';
      urlInput.addEventListener('change', ()=> localStorage.setItem(key, urlInput.value.trim()));
      const toast=(t)=>{ const el=document.getElementById('toast'); el.textContent=t; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),2000); };

      async function sha256Text(text){
        const enc = new TextEncoder().encode(text);
        const digest = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
      async function fetchIndex(){
        const url=(urlInput.value||'').trim();
        if(!url){ toast('Вкажіть URL індексу'); return null; }
        const res=await fetch(url,{cache:'no-store'});
        if(!res.ok){ toast('Помилка запиту'); return null; }
        return res.json();
      }

      let cached=null;
      testBtn?.addEventListener('click', async ()=>{
        const idx=await fetchIndex(); if(!idx) return;
        toast('Остання: v'+idx.latest);
        installBtn.disabled = !idx.latest;
      });
      fetchBtn?.addEventListener('click', async ()=>{
        const idx=await fetchIndex(); if(!idx) return;
        cached=idx; listBox.innerHTML='';
        (idx.files||[]).forEach(f=>{
          const b=document.createElement('button');
          b.className='btn'; b.style.display='block'; b.style.margin='4px 0';
          b.textContent=`v${f.version} — ${f.notes||f.url}`;
          b.onclick=()=>installFromURL(f);
          listBox.appendChild(b);
        });
        installBtn.disabled = !idx.latest;
      });
      installBtn?.addEventListener('click', async ()=>{
        if(!cached) return;
        const last=(cached.files||[]).find(x=>x.version===cached.latest);
        if(last) await installFromURL(last);
      });

      async function installFromURL(fileMeta){
        try{
          const res=await fetch(fileMeta.url,{cache:'no-store'}); if(!res.ok) { toast('Не вдалося завантажити'); return; }
          const text=await res.text();
          if(fileMeta.sha256 && fileMeta.sha256.length>0){
            const sum=await sha256Text(text);
            if(sum.toLowerCase()!==fileMeta.sha256.toLowerCase()){ toast('Хеш не збігається'); return; }
          }
          const mf=JSON.parse(text);
          if(mf.patch?.css){ const s=document.createElement('style'); s.textContent=mf.patch.css; document.head.appendChild(s); }
          if(mf.patch?.js){ try{ (new Function(mf.patch.js))(); }catch(e){} }
          if(mf.patch?.title){ document.getElementById('appTitle').textContent=mf.patch.title; document.title=mf.patch.title; }
          if(mf.version){
            document.querySelector('meta[name="app-version"]').content=mf.version;
            document.getElementById('currentVersion').textContent='v'+mf.version;
          }
          const arr=JSON.parse(localStorage.getItem('appliedPatches')||'[]');
          arr.push({version:mf.version, patch:mf.patch});
          localStorage.setItem('appliedPatches', JSON.stringify(arr));
          toast('Встановлено v'+mf.version);
        }catch(e){ toast('Помилка встановлення'); }
      }
    })();

    // ---------------- Очистка локальних даних
    document.getElementById('clearDataBtn')?.addEventListener('click', ()=>{
      const v=(document.getElementById('currentVersion')?.textContent||'v1.x').replace(/^v/,'');
      localStorage.clear();
      localStorage.setItem('appVersionPinned', v);
      location.reload();
    });
  </script>
</body>
</html>
