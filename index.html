<!doctype html>
<html lang="uk" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="app-version" content="3.1.0" />
  <title>MILACRM</title>

  <style>
    :root{
      --acc:#6a7dff; --btn:#273076; --btnH:#3a47a2; --btn2:#0f1530;
      --bg:#0f1426; --card:#141a33; --text:#e7ecff; --muted:#a9b3d9;
      --border:#262c4d; --input:#0f1530; --pill:#1a2140;
      --radius:14px; --fs:14px; --density:1; --shadow-a:0.0;
    }
    [data-theme="light"]{
      --bg:#f6f8ff; --card:#ffffff; --text:#1b2340; --muted:#5a6590;
      --border:#d8def4; --input:#eef2ff; --pill:#eef2ff;
    }
    html,body{height:100%;font-size:var(--fs)}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
         font:14px/1.45 system-ui,Segoe UI,Roboto,Arial;
         text-shadow:0 1px 0 rgba(0,0,0,var(--shadow-a));}
    .container{max-width:1200px;margin:18px auto;padding:0 14px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .tabs{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
    .tabs button{border:1px solid var(--border);background:#161d3a;color:var(--text);border-radius:12px;padding:8px 12px;cursor:pointer}
    .tabs button.active{outline:2px solid var(--acc)}
    .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#11183a;border:1px solid #2a356b;border-radius:14px;padding:8px 10px;margin-bottom:12px}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#7cff9f;box-shadow:0 0 0 4px rgba(124,255,159,.15)}
    .btn{border:1px solid #303a78;background:var(--btn);color:#e7ecff;border-radius:12px;padding:calc(8px*var(--density)) calc(12px*var(--density));cursor:pointer}
    .btn:hover{background:var(--btnH)}
    .btn-secondary{background:var(--btn2);border:1px solid #1c2350}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .section{display:none}.section.active{display:block}
    input,select,textarea{width:100%;background:var(--input);border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)}
    label{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}
    .muted{color:var(--muted);font-size:12px}
    #toast{position:fixed;right:16px;bottom:16px;background:#1a2140;border:1px solid var(--border);border-radius:10px;padding:8px 12px}
    .hidden{display:none!important}
    /* Animated gradient background (toggleable) */
    body.mw-anim-bg::before{content:"";position:fixed;inset:0;z-index:-1;
      background:linear-gradient(120deg,#0f1426,#1b244a,#273076,#0f1426);
      background-size:300% 300%;animation:mwShift 18s ease infinite;filter:saturate(1.05)}
    @keyframes mwShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    /* Kanban */
    #kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    #kanban .col{background:rgba(255,255,255,.03);border:1px solid #2a356b;border-radius:12px;padding:8px;min-height:180px}
    #kanban .cardx{background:#131a34;border:1px solid #2a356b;border-radius:12px;padding:8px;margin:6px 0;cursor:grab}
    /* Chips */
    #quickChips .chip{display:inline-block;background:#1a2140;border:1px solid #2a356b;border-radius:999px;padding:4px 8px;margin:2px 4px;color:#a9b3d9;font-size:12px;cursor:pointer}
    /* Progress */
    .progress{height:6px;background:#0f1530;border:1px solid #1c2350;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#4b64ff,#7a8cff)}
    /* Overlay lock */
    #lockOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:20}
    #lockBox{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;max-width:360px;width:92%}
    /* Vault table */
    #vaultTable td,#vaultTable th{padding:6px 8px;border-bottom:1px solid var(--border)}
  </style>

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script id="applied-patches" type="application/json">{"applied":[]}</script>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="appTitle">MILACRM</h1>
      <span class="pill">–≤–µ—Ä—Å—ñ—è: <b id="currentVersion">v3.1.0</b></span>
      <div class="tabs">
        <button id="tabForm" class="active">–õ—ñ–¥–∏</button>
        <button id="tabSettings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        <button id="tabAdvanced">–†–æ–∑—à–∏—Ä–µ–Ω—ñ</button>
        <button id="tabAccount">–û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å</button>
        <button id="tabAdmin" class="hidden">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</button>
        <button id="tabTraining">–ù–∞–≤—á–∞–Ω–Ω—è</button>
        <button id="themeToggleBtn">–¢–µ–º–∞</button>
      </div>
    </header>

    <!-- –í–µ—Ä—Ö–Ω—ñ–π —Ç—É–ª–±–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω—å -->
    <div class="topbar" id="mwTopbar">
      <span class="status-dot"></span><b>MILACRM</b>
      <span class="pill">–≤–µ—Ä—Å—ñ—è: <b id="verTxt">v3.1.0</b></span>
      <span style="flex:1"></span>
      <button class="btn" id="btnCheckOnline">–ü–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
      <button class="btn" id="btnPickFile">–û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</button>
      <button class="btn btn-secondary" id="btnInstallSel" disabled>–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button>
      <button class="btn" id="btnGoTraining">–ù–∞–≤—á–∞–Ω–Ω—è</button>
    </div>

    <!-- –õ–Ü–î–ò -->
    <section id="formSection" class="section active">
      <div class="grid">
        <div class="card" id="crmOptionsCard">
          <h2>–û–ø—Ü—ñ—ó CRM</h2>
          <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="bulkInProgressBtn">–ú–∞—Å–æ–≤–æ: ¬´–í –æ–±—Ä–æ–±—Ü—ñ¬ª</button>
            <button class="btn btn-secondary" id="bulkDeleteBtn">üóë –ú–∞—Å–æ–≤–æ –≤–∏–¥–∞–ª–∏—Ç–∏</button>
            <button class="btn" id="expJsonBtn">‚¨á JSON</button>
            <button class="btn" id="expCsvBtn">‚¨á CSV</button>
            <button class="btn" id="impJsonBtn">‚¨Ü –Ü–º–ø–æ—Ä—Ç JSON</button>
            <input id="impFile" type="file" accept=".json" class="hidden">
            <button class="btn" id="seedDemo">–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –¥–µ–º–æ</button>
            <button class="btn" id="showLog">–ñ—É—Ä–Ω–∞–ª –¥—ñ–π</button>
            <button class="btn" id="checkDup">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏</button>
            <button class="btn" id="toggleCols">–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ</button>
            <button class="btn btn-secondary" id="openTrash">–ö–æ—à–∏–∫</button>
          </div>
        </div>
        <div class="card">
          <h2>–ü–æ—à—É–∫</h2>
          <input id="searchInput" placeholder="–ü–æ—à—É–∫ –ø–æ —ñ–º–µ–Ω—ñ/—Ç–µ–ª–µ—Ñ–æ–Ω—É/—Ç–µ–≥–∞—Ö/—Å—Ç–∞—Ç—É—Å—É" />
          <div id="quickChips" class="card" style="margin-top:10px">
            <h2>–®–≤–∏–¥–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏</h2>
            <span class="chip">–ù–æ–≤–∏–π</span>
            <span class="chip">–í –æ–±—Ä–æ–±—Ü—ñ</span>
            <span class="chip">–ó–∞–∫—Ä–∏—Ç–∏–π</span>
            <span class="chip">facebook</span>
            <span class="chip">email</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>–ù–æ–≤–∏–π –ª—ñ–¥</h2>
        <form id="leadForm" class="grid">
          <div><label>–Ü–º º—è</label><input id="name" placeholder="–Ü–º º—è" /></div>
          <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="phone" placeholder="+380..." /></div>
          <div><label>Email</label><input id="email" type="email" placeholder="email@example.com" /></div>
          <div><label>–°—Ç–∞—Ç—É—Å</label>
            <select id="status"><option>–ù–æ–≤–∏–π</option><option>–í –æ–±—Ä–æ–±—Ü—ñ</option><option>–ó–∞–∫—Ä–∏—Ç–∏–π</option><option>–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π</option></select>
          </div>
          <div style="grid-column:1 / -1"><label>–¢–µ–≥–∏</label><input id="tags" placeholder="facebook, –≥–∞—Ä—è—á–∏–π" /></div>
          <div style="grid-column:1 / -1"><label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label><textarea id="comment" rows="3"></textarea></div>
          <div style="grid-column:1 / -1"><button class="btn" type="submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div>
        </form>
      </div>

      <div class="card table-wrap" style="margin-top:12px">
        <h2>–õ—ñ–¥–∏</h2>
        <table id="leadsTable">
          <thead>
          <tr><th></th><th>ID</th><th>–Ü–º º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>Email</th><th>–°—Ç–∞—Ç—É—Å</th><th>–¢–µ–≥–∏</th><th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th><th>–î—ñ—ó</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
    <section id="settingsSection" class="section">
      <div class="card" id="updatePanel">
        <h2>–û–Ω–æ–≤–ª–µ–Ω–Ω—è</h2>
        <div class="grid">
          <div>
            <label>URL —ñ–Ω–¥–µ–∫—Å—É</label>
            <input id="updIndexUrlSimple" placeholder="https://nikobo101.github.io/milawebos-site/updates/index.json">
          </div>
          <div style="display:flex;align-items:end;gap:8px">
            <button class="btn" id="updCheck">–ü–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
            <button class="btn btn-secondary" id="updInstallLatest" disabled>–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button>
          </div>
        </div>
        <div class="progress" style="margin-top:8px"><i id="updProg"></i></div>
        <div id="updResult" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card" id="designPanel" style="margin-top:12px">
        <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∏–∑–∞–π–Ω—É</h2>
        <div class="grid">
          <div><label>–ê–∫—Ü–µ–Ω—Ç–Ω–∏–π –∫–æ–ª—ñ—Ä</label><input type="color" id="dpAccent" value="#6a7dff"></div>
          <div><label>–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É</label>
            <select id="dpFont"><option value="13">13</option><option value="14" selected>14</option><option value="15">15</option><option value="16">16</option></select>
          </div>
          <div><label>–©—ñ–ª—å–Ω—ñ—Å—Ç—å —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</label>
            <select id="dpDensity"><option value="compact">–ö–æ–º–ø–∞–∫—Ç–Ω–∞</option><option value="normal" selected>–ó–≤–∏—á–∞–π–Ω–∞</option><option value="comfortable">–ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞</option></select>
          </div>
          <div><label>–ê–Ω—ñ–º–æ–≤–∞–Ω–∏–π —Ñ–æ–Ω</label>
            <select id="dpAnimBg"><option value="on" selected>–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option><option value="off">–í–∏–º–∫–Ω–µ–Ω–æ</option></select>
          </div>
          <div><label>–ö–æ–Ω—Ç—Ä–∞—Å—Ç —Ç–µ–∫—Å—Ç—É</label>
            <input id="dpContrast" type="range" min="0" max="0.4" step="0.05" value="0.1">
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="dpApply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          <button class="btn btn-secondary" id="dpReset">–°–∫–∏–Ω—É—Ç–∏</button>
          <button class="btn" id="presetDark">Dark</button>
          <button class="btn" id="presetLight">Light</button>
          <button class="btn" id="presetMinecraft">Minecraft</button>
        </div>
        <div class="muted" style="margin-top:6px">* –í–∏–º–∫–Ω–∏ –∞–Ω—ñ–º–æ–≤–∞–Ω–∏–π —Ñ–æ–Ω, —è–∫—â–æ –±—Ä–∞–∫—É—î –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>
      </div>
    </section>

    <!-- –†–û–ó–®–ò–†–ï–ù–Ü -->
    <section id="advancedFeaturesSection" class="section">
      <div class="grid">
        <div class="card">
          <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
          <canvas id="chartStatusPie" height="140"></canvas>
        </div>
        <div class="card">
          <h2>–î–∏–Ω–∞–º—ñ–∫–∞ –ø–æ –¥–Ω—è—Ö</h2>
          <canvas id="chartByDay" height="140"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>–ö–∞–Ω–±–∞–Ω</h2>
        <div id="kanban"></div>
      </div>

      <div class="grid" style="margin-top:12px" id="advOps">
        <div class="card" id="advArchive">
          <h2>–ê—Ä—Ö—ñ–≤ / –ö–æ—à–∏–∫</h2>
          <div class="muted">–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω—ñ –ª—ñ–¥–∏ –¥–æ –∞—Ä—Ö—ñ–≤—É, –ø–µ—Ä–µ–≥–ª—è–¥/–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è, –æ—á–∏—â–µ–Ω–Ω—è.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn" id="toArchiveBtn">‚Üí –í –∞—Ä—Ö—ñ–≤</button>
            <button class="btn btn-secondary" id="viewArchiveBtn">–í—ñ–¥–∫—Ä–∏—Ç–∏ –∞—Ä—Ö—ñ–≤</button>
            <button class="btn btn-secondary" id="emptyTrashBtn">–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫</button>
          </div>
        </div>
        <div class="card" id="advDup">
          <h2>–î—É–±–ª—ñ–∫–∞—Ç–∏</h2>
          <div class="muted">–ü–æ—à—É–∫ –ø–æ email/—Ç–µ–ª–µ—Ñ–æ–Ω—É —ñ –∑–ª–∏—Ç—Ç—è (—Ä—É—á–Ω–µ).</div>
          <button class="btn" id="findDupBtn" style="margin-top:6px">–ó–Ω–∞–π—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏</button>
        </div>
        <div class="card" id="advCustomFields">
          <h2>–ö–∞—Å—Ç–æ–º–Ω—ñ –ø–æ–ª—è</h2>
          <div class="muted">–î–æ–¥–∞–≤–∞–π –≤–ª–∞—Å–Ω—ñ –ø–æ–ª—è –¥–æ —Ñ–æ—Ä–º–∏ –ª—ñ–¥a.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="cfName" placeholder="–ù–∞–ø—Ä.: company">
            <button class="btn" id="addCFBtn">–î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ</button>
          </div>
        </div>
        <div class="card" id="helpCard">
          <h2>–ü—ñ–¥–∫–∞–∑–∫–∏</h2>
          <div class="muted">/ ‚Äî –ø–æ—à—É–∫, N ‚Äî –Ω–æ–≤–∏–π –ª—ñ–¥, Ctrl+S ‚Äî –∑–±–µ—Ä–µ–≥—Ç–∏, Shift+Del ‚Äî –º–∞—Å–æ–≤–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è</div>
        </div>
      </div>
    </section>

    <!-- –û–ë–õ–Ü–ö–û–í–ò–ô –ó–ê–ü–ò–° + VAULT -->
    <section id="accountSection" class="section card">
      <h2>–û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å</h2>
      <div class="grid">
        <div><label>–õ–æ–≥—ñ–Ω</label><input id="accUser" placeholder="username"></div>
        <div><label>–ü–∞—Ä–æ–ª—å</label><input id="accPass" type="password" placeholder="–ø–∞—Ä–æ–ª—å"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button class="btn" id="accCreate">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
        <button class="btn btn-secondary" id="accLogin">–£–≤—ñ–π—Ç–∏</button>
        <button class="btn btn-secondary" id="accLogout">–í–∏–π—Ç–∏</button>
        <button class="btn" id="accShowRecovery">–ü–æ–∫–∞–∑–∞—Ç–∏ Recovery Key</button>
        <button class="btn" id="accResetByRecovery">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–∞ Recovery Key</button>
      </div>
      <div id="accInfo" class="muted" style="margin-top:8px"></div>

      <div class="card" id="vaultCard" style="margin-top:12px;display:none">
        <h2>Vault (–∑–∞—Ö–∏—â–µ–Ω—ñ –∑–∞–ø–∏—Å–∏)</h2>
        <div class="grid">
          <div><label>–ù–∞–∑–≤–∞</label><input id="vLabel"></div>
          <div><label>–õ–æ–≥—ñ–Ω</label><input id="vLogin"></div>
          <div><label>–ü–∞—Ä–æ–ª—å</label><input id="vPassword" type="password"></div>
          <div><label>–ù–æ—Ç–∞—Ç–∫–∞</label><input id="vNote"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="vaultAdd">–î–æ–¥–∞—Ç–∏ –≤ Vault</button>
          <button class="btn btn-secondary" id="vaultReload">–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
        </div>
        <div style="margin-top:10px">
          <table id="vaultTable"><thead><tr><th>–ù–∞–∑–≤–∞</th><th>–õ–æ–≥—ñ–Ω</th><th>–ü–∞—Ä–æ–ª—å</th><th>–ù–æ—Ç–∞—Ç–∫–∞</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="muted" style="margin-top:6px">* –î–∞–Ω—ñ —à–∏—Ñ—Ä—É—é—Ç—å—Å—è AES-GCM –ª–æ–∫–∞–ª—å–Ω–æ. –ó—Ä–æ–±—ñ—Ç—å –±–µ–∫–∞–ø –±—Ä–∞—É–∑–µ—Ä–∞.</div>
      </div>
    </section>

    <!-- –ê–î–ú–Ü–ù-–ü–ê–ù–ï–õ–¨ -->
    <section id="adminSection" class="section card hidden">
      <h2>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h2>
      <div class="muted">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏, —Ä–æ–ª—è–º–∏ —Ç–∞ —Å–µ—Å—ñ—è–º–∏</div>
      <div style="margin-top:8px" id="adminUsers"></div>
    </section>

    <!-- –ù–ê–í–ß–ê–ù–ù–Ø -->
    <section id="trainingSection" class="section card">
      <h2>–ù–∞–≤—á–∞–Ω–Ω—è MILACRM</h2>
      <div class="card step"><b>–ö—Ä–æ–∫ 1.</b> –î–æ–¥–∞–π—Ç–µ –ª—ñ–¥ —É –≤–∫–ª–∞–¥—Ü—ñ ¬´–õ—ñ–¥–∏¬ª. <div class="muted">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏¬ª.</div></div>
      <div class="card step"><b>–ö—Ä–æ–∫ 2.</b> –°–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—à—É–∫/—Ñ—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å ¬´–®–≤–∏–¥–∫–∏–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª (—á—ñ–ø—Å–∏ –ø—ñ–¥ –ø–æ—à—É–∫–æ–º).</div>
      <div class="card step"><b>–ö—Ä–æ–∫ 3.</b> –í—ñ–¥–∫—Ä–∏–π—Ç–µ ¬´–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí –û–Ω–æ–≤–ª–µ–Ω–Ω—è¬ª —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è¬ª.</div>
      <div class="card step"><b>–ö—Ä–æ–∫ 4.</b> –ü–µ—Ä–µ–π–¥—ñ—Ç—å —É ¬´–†–æ–∑—à–∏—Ä–µ–Ω—ñ¬ª ‚Üí –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è –ö–∞–Ω–±–∞–Ω, –ê—Ä—Ö—ñ–≤, –î—É–±–ª—ñ–∫–∞—Ç–∏, –ï–∫—Å–ø–æ—Ä—Ç.</div>
    </section>
  </div>

  <div id="toast" class="hidden">OK</div>

  <!-- Lock overlay -->
  <div id="lockOverlay">
    <div id="lockBox">
      <h3>–°–µ—Å—ñ—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞</h3>
      <div class="muted">–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –∞–∫–∞—É–Ω—Ç–∞, —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</div>
      <input id="lockPwd" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-top:8px;width:100%">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="lockUnlock">–†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏</button>
      </div>
      <div id="lockMsg" class="muted" style="margin-top:6px"></div>
    </div>
  </div>

  <script>
  (function(){
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));
    const toast=t=>{const el=$('#toast');el.textContent=t;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),2200);};

    // ===== –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ –≤–∫–ª–∞–¥–∫–∞—Ö =====
    const sections={tabForm:'formSection',tabSettings:'settingsSection',tabAdvanced:'advancedFeaturesSection',tabAccount:'accountSection',tabAdmin:'adminSection',tabTraining:'trainingSection'};
    Object.keys(sections).forEach(id=>{
      const btn=$('#'+id);
      btn?.addEventListener('click',()=>{
        $$('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        $$('.section').forEach(s=>s.classList.remove('active'));
        $('#'+sections[id])?.classList.add('active');
      });
    });
    $('#btnGoTraining')?.addEventListener('click',()=>$('#tabTraining')?.click());

    // ===== –¢–µ–º–∞ + —Ñ–æ–Ω + –∫–æ–Ω—Ç—Ä–∞—Å—Ç =====
    const themeBtn=$('#themeToggleBtn');
    const savedTheme=localStorage.getItem('theme')||'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    const animPref=(localStorage.getItem('mw_anim_bg')||'on')==='on';
    document.body.classList.toggle('mw-anim-bg', animPref);
    const savedShadow=parseFloat(localStorage.getItem('mw_shadow_a')||'0.1');
    document.documentElement.style.setProperty('--shadow-a', savedShadow.toString());
    themeBtn?.addEventListener('click', ()=>{
      const cur=document.documentElement.getAttribute('data-theme');
      const next=cur==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    // ===== SW (–æ—Ñ–ª–∞–π–Ω) =====
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

    // ===== –î–∞–Ω—ñ –ª—ñ–¥—ñ–≤ =====
    const LEADS='leads', TRASH='leads_trash', ARCH='leads_archive';
    const load = (k,d=[]) => { try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d));}catch(e){return d} };
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    function renderTable(){
      const q=($('#searchInput')?.value||'').trim().toLowerCase();
      const tb=$('#leadsTable tbody'); tb.innerHTML='';
      load(LEADS).filter(l=>{
        const hay=[l.name,l.phone,l.email,l.status,l.tags].map(x=>(x||'').toLowerCase()).join('|');
        return !q || hay.includes(q);
      }).forEach(l=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="sel" data-id="${l.id}"></td>
          <td>${l.id}</td>
          <td>${l.name||''}</td>
          <td>${l.phone||''}</td>
          <td>${l.email||''}</td>
          <td>${l.status||''}</td>
          <td>${l.tags||''}</td>
          <td>${l.comment||''}</td>
          <td>
            <button class="btn btn-secondary editBtn" data-id="${l.id}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
            <button class="btn btn-secondary delBtn" data-id="${l.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    window.renderTable=renderTable;

    $('#leadForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const leads=load(LEADS);
      const id=Date.now();
      const get=v=>$('#'+v).value.trim();
      leads.push({
        id, name:get('name'), phone:get('phone'), email:get('email'),
        status:$('#status').value, tags:get('tags'), comment:get('comment'),
        date: new Date().toISOString(), updatedAt: new Date().toISOString()
      });
      save(LEADS, leads); renderTable(); toast('–õ—ñ–¥ –¥–æ–¥–∞–Ω–æ'); e.target.reset();
    });

    // –†–µ–¥–∞–≥—É–≤–∞—Ç–∏/–í–∏–¥–∞–ª–∏—Ç–∏/–ú–∞—Å–æ–≤–µ/–ö–æ—à–∏–∫
    document.addEventListener('click',(e)=>{
      const editBtn=e.target.closest('.editBtn');
      const delBtn=e.target.closest('.delBtn');
      if(editBtn){
        const id=Number(editBtn.dataset.id);
        const a=load(LEADS); const i=a.findIndex(x=>x.id===id); if(i<0) return;
        const l=a[i];
        const name=prompt('–Ü–º º—è:', l.name||''); if(name===null) return;
        const phone=prompt('–¢–µ–ª–µ—Ñ–æ–Ω:', l.phone||''); if(phone===null) return;
        const email=prompt('Email:', l.email||''); if(email===null) return;
        const status=prompt('–°—Ç–∞—Ç—É—Å (–ù–æ–≤–∏–π/–í –æ–±—Ä–æ–±—Ü—ñ/–ó–∞–∫—Ä–∏—Ç–∏–π/–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π):', l.status||'–ù–æ–≤–∏–π'); if(status===null) return;
        const tags=prompt('–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É):', l.tags||''); if(tags===null) return;
        const comment=prompt('–ö–æ–º–µ–Ω—Ç–∞—Ä:', l.comment||''); if(comment===null) return;
        a[i]={...l,name,phone,email,status,tags,comment,updatedAt:new Date().toISOString()};
        save(LEADS,a); renderTable(); toast('–ó–º—ñ–Ω–µ–Ω–æ'); return;
      }
      if(delBtn){
        const id=Number(delBtn.dataset.id);
        if(!confirm('–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –ª—ñ–¥ #' + id + ' —É –∫–æ—à–∏–∫?')) return;
        let a=load(LEADS); const rec=a.find(x=>x.id===id); a=a.filter(x=>x.id!==id); save(LEADS,a);
        const trash=load(TRASH); trash.push({...rec, deletedAt:new Date().toISOString()}); save(TRASH,trash);
        renderTable(); toast('–ü–µ—Ä–µ–º—ñ—â–µ–Ω–æ —É –∫–æ—à–∏–∫'); return;
      }
    });
    $('#bulkDeleteBtn')?.addEventListener('click',()=>{
      const checked=$$('#leadsTable tbody .sel:checked'); if(!checked.length){toast('–ù–µ –æ–±—Ä–∞–Ω–æ'); return;}
      if(!confirm('–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –æ–±—Ä–∞–Ω—ñ ('+checked.length+') —É –∫–æ—à–∏–∫?'))return;
      let a=load(LEADS); const ids=new Set(checked.map(cb=>Number(cb.dataset.id)));
      const moving=a.filter(x=>ids.has(x.id)); a=a.filter(x=>!ids.has(x.id)); save(LEADS,a);
      const trash=load(TRASH); save(TRASH, trash.concat(moving.map(x=>({...x,deletedAt:new Date().toISOString()}))));
      renderTable(); toast('–ü–µ—Ä–µ–º—ñ—â–µ–Ω–æ: '+ids.size);
    });
    $('#openTrash')?.addEventListener('click',()=>{
      const t=load(TRASH);
      const out=t.slice(-10).map(x=>`#${x.id}: ${x.name||''} (${x.deletedAt})`).join('\n') || '–ü–æ—Ä–æ–∂–Ω—å–æ';
      const id=prompt('–ö–æ—à–∏–∫ (–æ—Å—Ç–∞–Ω–Ω—ñ 10)\n'+out+'\n\n–í–∫–∞–∂—ñ—Ç—å ID –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (–∞–±–æ –ø–æ—Ä–æ–∂–Ω—å–æ):');
      if(!id) return;
      const num=Number(id);
      let trash=load(TRASH); const rec=trash.find(x=>x.id===num); if(!rec){toast('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return;}
      trash=trash.filter(x=>x.id!==num); save(TRASH,trash);
      const a=load(LEADS); a.push(rec); save(LEADS,a); renderTable(); toast('–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ #'+num);
    });
    $('#emptyTrashBtn')?.addEventListener('click',()=>{
      if(!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫? –î—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;
      localStorage.removeItem(TRASH); toast('–ö–æ—à–∏–∫ –æ—á–∏—â–µ–Ω–æ');
    });
    $('#bulkInProgressBtn')?.addEventListener('click', ()=>{
      const leads=load(LEADS);
      $$('#leadsTable tbody .sel:checked').forEach(cb=>{
        const id=Number(cb.dataset.id); const i=leads.findIndex(l=>l.id===id);
        if(i>-1) leads[i].status='–í –æ–±—Ä–æ–±—Ü—ñ';
      });
      save(LEADS,leads); renderTable(); toast('–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ');
    });
    $('#searchInput')?.addEventListener('input', renderTable);
    $('#quickChips')?.addEventListener('click', e=>{
      const tag=e.target.closest('.chip')?.textContent; if(!tag) return;
      $('#searchInput').value=tag; $('#searchInput').dispatchEvent(new Event('input'));
    });

    // –ï–∫—Å–ø–æ—Ä—Ç/–Ü–º–ø–æ—Ä—Ç
    $('#expJsonBtn')?.addEventListener('click',()=>{
      const data=JSON.stringify(load(LEADS),null,2);
      const url=URL.createObjectURL(new Blob([data],{type:'application/json'}));
      const a=document.createElement('a'); a.href=url; a.download='leads.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#expCsvBtn')?.addEventListener('click',()=>{
      const arr=load(LEADS); const head=['id','name','phone','email','status','tags','comment'];
      const rows=[head.join(',')].concat(arr.map(l=>head.map(k=>(''+(l[k]??'')).replace(/\"/g,'\"\"')).map(x=>`\"${x}\"`).join(',')));
      const csv=rows.join('\n'); const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      const a=document.createElement('a'); a.href=url; a.download='leads.csv'; a.click(); URL.revokeObjectURL(url);
    });
    $('#impJsonBtn')?.addEventListener('click',()=>$('#impFile')?.click());
    $('#impFile')?.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ const text=await f.text(); const arr=JSON.parse(text); if(!Array.isArray(arr)) throw 0;
        const cur=load(LEADS); save(LEADS, cur.concat(arr)); renderTable(); toast('–Ü–º–ø–æ—Ä—Ç –≤–∏–∫–æ–Ω–∞–Ω–æ');
      }catch{ toast('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–∞–π–ª —ñ–º–ø–æ—Ä—Ç—É'); }
      e.target.value='';
    });

    // –î–µ–º–æ–¥–∞–Ω—ñ, –∂—É—Ä–Ω–∞–ª, –¥—É–±–ª—ñ–∫–∞—Ç–∏, –∫–æ–ª–æ–Ω–∫–∏
    let MW_LOG=[];
    window.mwLog=(m)=>{MW_LOG.push({t:Date.now(),m}); if(MW_LOG.length>100) MW_LOG.shift();};
    $('#seedDemo')?.addEventListener('click',()=>{
      const now=Date.now();
      const demo=[
        {id:now+1,name:'–Ü—Ä–∏–Ω–∞',phone:'+38000000001',email:'irina@example.com',status:'–ù–æ–≤–∏–π',tags:'facebook',comment:'—Ü—ñ–∫–∞–≤–∏–ª–∞—Å—å –¥–µ–º–æ',date:new Date().toISOString(),updatedAt:new Date().toISOString()},
        {id:now+2,name:'–û–ª–µ–≥',phone:'+38000000002',email:'oleg@example.com',status:'–í –æ–±—Ä–æ–±—Ü—ñ',tags:'email',comment:'–ø–æ—Ç—Ä—ñ–±–µ–Ω –ø—Ä–∞–π—Å',date:new Date().toISOString(),updatedAt:new Date().toISOString()}
      ];
      const a=load(LEADS); save(LEADS,a.concat(demo)); renderTable(); toast('–î–µ–º–æ–¥–∞–Ω—ñ –¥–æ–¥–∞–Ω–æ');
    });
    $('#showLog')?.addEventListener('click',()=>alert('–û—Å—Ç–∞–Ω–Ω—ñ –¥—ñ—ó:\n'+MW_LOG.slice(-10).map(x=>new Date(x.t).toLocaleTimeString('uk-UA')+' ‚Äî '+x.m).join('\n')));
    $('#checkDup')?.addEventListener('click',()=>{
      const a=load(LEADS); const map=new Set();
      const dups=a.filter(l=>{const k=((l.email||'')+'|'+(l.phone||'')).toLowerCase(); if(map.has(k)) return true; map.add(k); return false;});
      alert('–î—É–±–ª—ñ–∫–∞—Ç—ñ–≤: '+dups.length);
    });
    $('#toggleCols')?.addEventListener('click',()=>{
      const labels=['Email','–¢–µ–≥–∏','–ö–æ–º–µ–Ω—Ç–∞—Ä'];
      labels.forEach(label=>{
        const th=[...$('#leadsTable thead tr').children].find(x=>x.textContent===label);
        if(!th) return; const idx=[...th.parentElement.children].indexOf(th);
        $$('#leadsTable tr').forEach(tr=>{ const td=tr.children[idx]; if(td) td.classList.toggle('hidden'); });
      });
    });

    // ===== –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ =====
    function drawCharts(){
      try{
        const a=load(LEADS); const byStatus={'–ù–æ–≤–∏–π':0,'–í –æ–±—Ä–æ–±—Ü—ñ':0,'–ó–∞–∫—Ä–∏—Ç–∏–π':0,'–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π':0};
        a.forEach(l=>{ if(byStatus[l.status]!=null) byStatus[l.status]++; });
        new Chart(document.getElementById('chartStatusPie'),{
          type:'pie', data:{labels:Object.keys(byStatus), datasets:[{data:Object.values(byStatus)}]}, options:{plugins:{legend:{position:'bottom'}}}
        });
        const days={}; a.forEach(l=>{ const d=(l.date||'').slice(0,10); if(!d) return; days[d]=(days[d]||0)+1; });
        new Chart(document.getElementById('chartByDay'),{
          type:'line', data:{labels:Object.keys(days), datasets:[{data:Object.values(days), tension:.3}]}, options:{plugins:{legend:{display:false}}}
        });
      }catch(e){}
    }

    // ===== –ê–∫–∞—É–Ω—Ç–∏/–†–æ–ª—ñ/–°–µ—Å—ñ—ó —Ç–∞ VAULT –∑ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è–º =====
    const ACCS='accounts', SESS='acct_session';
    const VAULT = u => 'vault_'+u; // –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π JSON
    // Base64 helpers
    const b64 = { enc:u8=>btoa(String.fromCharCode(...u8)), dec:b=>Uint8Array.from(atob(b),c=>c.charCodeAt(0)) };
    // Crypto helpers
    async function sha256Hex(text){ const d=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
    async function kdf(password, salt){ const key=await crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'}, key, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']); }
    async function aesEncJson(key, obj){ const iv=crypto.getRandomValues(new Uint8Array(12));
      const data=new TextEncoder().encode(JSON.stringify(obj));
      const ct= new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, data));
      return {iv:b64.enc(iv), ct:b64.enc(ct)};
    }
    async function aesDecJson(key, pack){ const iv=b64.dec(pack.iv), ct=b64.dec(pack.ct);
      const pt= new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, ct));
      return JSON.parse(new TextDecoder().decode(pt));
    }
    async function genDataKey(){ return crypto.getRandomValues(new Uint8Array(32)); } // raw 256-bit
    async function wrapRaw(raw, key){ return aesEncJson(key, {raw:b64.enc(raw)}); }
    async function unwrapRaw(pack, key){ const obj=await aesDecJson(key, pack); return b64.dec(obj.raw); }

    function getAccounts(){ return load(ACCS,[]); }
    function setAccounts(a){ save(ACCS,a); }
    function getSession(){ return load(SESS,null); }
    function setSession(s){ save(SESS,s); }

    function ensureAdminTab(){ const sess=getSession(); const acc=getAccounts().find(x=>x.u===sess?.u); $('#tabAdmin')?.classList.toggle('hidden', !(acc && acc.role==='admin')); }
    function uiGate(){ const logged=!!getSession(); $('#settingsSection')?.classList.toggle('hidden',!logged); $('#advancedFeaturesSection')?.classList.toggle('hidden',!logged); $('#vaultCard')?.style.setProperty('display', logged?'block':'none'); ensureAdminTab(); }
    uiGate();

    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–∫–∞—É–Ω—Ç–∞
    $('#accCreate')?.addEventListener('click', async ()=>{
      const u=$('#accUser').value.trim(); const p=$('#accPass').value; if(!u||!p) {toast('–õ–æ–≥—ñ–Ω —ñ –ø–∞—Ä–æ–ª—å'); return;}
      let A=getAccounts(); if(A.find(x=>x.u===u)){ toast('–¢–∞–∫–∏–π –ª–æ–≥—ñ–Ω –≤–∂–µ —ñ—Å–Ω—É—î'); return; }
      const salt=b64.enc(crypto.getRandomValues(new Uint8Array(16)));
      const salt2=b64.enc(crypto.getRandomValues(new Uint8Array(16)));
      const pwHash=await sha256Hex(p + salt);
      const kPw = await kdf(p, b64.dec(salt));
      const kRecBase = [...crypto.getRandomValues(new Uint8Array(24))].map(b=>('ABCDEFGHIJKLMNOPQRSTUVWXYZ234567')[b%32]).join('');
      const kRec = await kdf(kRecBase, b64.dec(salt2));
      const dataKey = await genDataKey();
      const wrappedPW = await wrapRaw(dataKey, kPw);
      const wrappedRK = await wrapRaw(dataKey, kRec);
      const role = A.length===0 ? 'admin' : 'user';
      A.push({u, role, salt, salt2, pwHash, wrappedPW, wrappedRK, createdAt: Date.now()});
      setAccounts(A);
      setSession({u, ts: Date.now()});
      $('#accInfo').innerHTML = '–ê–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ. <b>–ó–±–µ—Ä–µ–∂—ñ—Ç—å Recovery Key:</b> <code>'+kRecBase+'</code>';
      uiGate(); toast('–°—Ç–≤–æ—Ä–µ–Ω–æ —ñ —É–≤—ñ–π–¥–µ–Ω–æ');
      renderAdmin();
    });

    // –í—Ö—ñ–¥
    $('#accLogin')?.addEventListener('click', async ()=>{
      const u=$('#accUser').value.trim(); const p=$('#accPass').value;
      const rec=getAccounts().find(x=>x.u===u); if(!rec){ toast('–ù–µ–º–∞—î —Ç–∞–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞'); return; }
      const ok = (await sha256Hex(p + rec.salt)) === rec.pwHash;
      if(!ok){ $('#accInfo').textContent='–ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ'; return; }
      setSession({u, ts:Date.now()}); $('#accInfo').textContent='–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π'; uiGate(); renderAdmin();
    });

    // –í–∏—Ö—ñ–¥
    $('#accLogout')?.addEventListener('click', ()=>{ localStorage.removeItem(SESS); uiGate(); $('#accInfo').textContent='–í–∏—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ'; });

    // –ü–æ–∫–∞–∑ Recovery Key (–≤–∏–º–∞–≥–∞—î –ª–æ–≥—ñ–Ω—É)
    $('#accShowRecovery')?.addEventListener('click', async ()=>{
      const sess=getSession(); if(!sess){ toast('–°–ø–µ—Ä—à—É —É–≤—ñ–π–¥—ñ—Ç—å'); return; }
      const rec=getAccounts().find(x=>x.u===sess.u); if(!rec){ toast('–ê–∫–∞—É–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); return; }
      alert('Recovery Key (–∑–±–µ—Ä—ñ–≥–∞–π—Ç–µ –≤ –±–µ–∑–ø–µ—á–Ω–æ–º—É –º—ñ—Å—Ü—ñ):\n' +
        '(—Ü–µ–π –∫–ª—é—á –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–∏—à–µ —è–∫ –æ–±–≥–æ—Ä—Ç–∫–∞; '+
        '—è–∫—â–æ –∑–∞–≥—É–±–ª–µ–Ω–æ ‚Äî —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç —ñ –ø–µ—Ä–µ–Ω–µ—Å—ñ—Ç—å –¥–∞–Ω—ñ)\n\n*–ü–æ—Ç–æ—á–Ω–∏–π –∫–ª—é—á –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —É —á–∏—Å—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É.\n' +
        '–°—Ç–≤–æ—Ä—ñ—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–∏–π –¥—É–±–ª—ñ–∫–∞—Ç –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∞–∫–∞—É–Ω—Ç–∞.');
    });

    // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞ Recovery Key (–ø–µ—Ä–µ–≤–∏–¥–∞—á–∞ –ø–∞—Ä–æ–ª—è –±–µ–∑ –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö Vault)
    $('#accResetByRecovery')?.addEventListener('click', async ()=>{
      const u=prompt('–í–∫–∞–∂—ñ—Ç—å –ª–æ–≥—ñ–Ω –∞–∫–∞—É–Ω—Ç–∞:'); if(!u) return;
      const rec=getAccounts().find(x=>x.u===u); if(!rec){ toast('–ù–µ–º–∞—î —Ç–∞–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞'); return; }
      const rk=prompt('–í–≤–µ–¥—ñ—Ç—å Recovery Key:'); if(!rk) return;
      const newPwd=prompt('–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å:'); if(!newPwd) return;
      try{
        const kRec=await kdf(rk, b64.dec(rec.salt2));
        const dataKeyRaw = await unwrapRaw(rec.wrappedRK, kRec);
        const kNew = await kdf(newPwd, b64.dec(rec.salt));
        const wrappedPW = await wrapRaw(dataKeyRaw, kNew);
        const pwHash=await sha256Hex(newPwd + rec.salt);
        rec.wrappedPW = wrappedPW; rec.pwHash=pwHash;
        setAccounts(getAccounts().map(a=>a.u===u?rec:a));
        toast('–ü–∞—Ä–æ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ'); $('#accInfo').textContent='–ü–∞—Ä–æ–ª—å —Å–∫–∏–Ω—É—Ç–æ –∑–∞ Recovery Key';
      }catch(e){ toast('–ù–µ–≤—ñ—Ä–Ω–∏–π Recovery Key'); }
    });

    // ===== VAULT (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π) =====
    async function vaultGetDataKey(u, password){
      const rec=getAccounts().find(x=>x.u===u); if(!rec) throw 'no user';
      const kPw = await kdf(password, b64.dec(rec.salt));
      const raw = await unwrapRaw(rec.wrappedPW, kPw);
      // –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ CryptoKey –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è/–¥–µ—à–∏—Ñ—Ä—É
      return await crypto.subtle.importKey('raw', raw, 'AES-GCM', false, ['encrypt','decrypt']);
    }
    async function vaultLoad(u, key){
      try{ const pack=load(VAULT(u), null); if(!pack) return [];
        return await aesDecJson(key, pack);
      }catch(e){ return []; }
    }
    async function vaultSave(u, key, arr){
      const pack = await aesEncJson(key, arr);
      save(VAULT(u), pack);
    }
    async function vaultRender(){
      const sess=getSession(); if(!sess) return;
      const pwd=$('#accPass').value; if(!pwd) return; // –¥–ª—è –ø–µ—Ä—à–æ–≥–æ –ø–æ–∫–∞–∑—É –≤–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å —É –ø–æ–ª—ñ
      try{
        const key=await vaultGetDataKey(sess.u, pwd);
        const arr=await vaultLoad(sess.u, key);
        const tb=$('#vaultTable tbody'); tb.innerHTML='';
        (arr||[]).forEach((v,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${v.label||''}</td><td>${v.login||''}</td><td>${v.password||''}</td><td>${v.note||''}</td>
                        <td><button class="btn btn-secondary" data-i="${i}" data-act="vdel">üóë</button></td>`;
          tb.appendChild(tr);
        });
      }catch(e){ /* ignore */ }
    }
    $('#vaultReload')?.addEventListener('click', vaultRender);
    $('#vaultAdd')?.addEventListener('click', async ()=>{
      const sess=getSession(); if(!sess){ toast('–°–ø–µ—Ä—à—É —É–≤—ñ–π–¥—ñ—Ç—å'); return; }
      const pwd=$('#accPass').value; if(!pwd){ toast('–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å —É –ø–æ–ª—ñ –≤–∏—â–µ'); return; }
      try{
        const key=await vaultGetDataKey(sess.u, pwd);
        const arr=await vaultLoad(sess.u, key);
        arr.push({label:$('#vLabel').value, login:$('#vLogin').value, password:$('#vPassword').value, note:$('#vNote').value, ts:Date.now()});
        await vaultSave(sess.u, key, arr);
        $('#vLabel').value=$('#vLogin').value=$('#vPassword').value=$('#vNote').value='';
        toast('–î–æ–¥–∞–Ω–æ —É Vault'); vaultRender();
      }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ Vault'); }
    });
    document.addEventListener('click', async (e)=>{
      const b=e.target.closest('button[data-act="vdel"]'); if(!b) return;
      const i=Number(b.dataset.i);
      const sess=getSession(); if(!sess) return;
      const pwd=$('#accPass').value; if(!pwd) return;
      try{ const key=await vaultGetDataKey(sess.u, pwd);
        const arr=await vaultLoad(sess.u, key); arr.splice(i,1); await vaultSave(sess.u, key, arr); toast('–í–∏–¥–∞–ª–µ–Ω–æ'); vaultRender();
      }catch{}
    });

    // ===== –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å =====
    function renderAdmin(){
      const sess=getSession(); const acc=getAccounts().find(x=>x.u===sess?.u);
      $('#tabAdmin')?.classList.toggle('hidden', !(acc && acc.role==='admin'));
      if(!(acc && acc.role==='admin')) return;
      const box=$('#adminUsers'); const A=getAccounts();
      box.innerHTML = '<table><thead><tr><th>–õ–æ–≥—ñ–Ω</th><th>–†–æ–ª—å</th><th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th><th>–î—ñ—ó</th></tr></thead><tbody>'+
        A.map(u=>`<tr><td>${u.u}</td><td>${u.role}</td><td>${new Date(u.createdAt).toLocaleString('uk-UA')}</td>
        <td>
          <button class="btn btn-secondary" data-act="role" data-u="${u.u}">${u.role==='admin'?'–ó—Ä–æ–±–∏—Ç–∏ user':'–ó—Ä–æ–±–∏—Ç–∏ admin'}</button>
          <button class="btn btn-secondary" data-act="logout" data-u="${u.u}">–í–∏–π—Ç–∏ –∑ —Å–µ—Å—ñ—ó</button>
          <button class="btn" data-act="deluser" data-u="${u.u}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </td></tr>`).join('') + '</tbody></table>';
    }
    document.addEventListener('click',(e)=>{
      const el=e.target.closest('button[data-act]'); if(!el) return;
      const act=el.dataset.act, user=el.dataset.u;
      if(act==='role'){ const A=getAccounts(); const i=A.findIndex(x=>x.u===user); if(i<0)return; A[i].role = (A[i].role==='admin'?'user':'admin'); setAccounts(A); toast('–†–æ–ª—å –∑–º—ñ–Ω–µ–Ω–æ'); renderAdmin(); ensureAdminTab(); }
      if(act==='logout'){ const s=getSession(); if(s?.u===user) localStorage.removeItem(SESS); toast('–°–µ—Å—ñ—é –æ—á–∏—â–µ–Ω–æ'); }
      if(act==='deluser'){ if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ '+user+'?')) return;
        setAccounts(getAccounts().filter(x=>x.u!==user)); localStorage.removeItem(VAULT(user)); toast('–í–∏–¥–∞–ª–µ–Ω–æ'); renderAdmin(); ensureAdminTab(); uiGate();
      }
    });

    // ===== –ê–≤—Ç–æ–±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Å–µ—Å—ñ—ó =====
    let idleTimer=null;
    function armIdle(){ clearTimeout(idleTimer); idleTimer=setTimeout(()=>lockNow(), 10*60*1000); } // 10 —Ö–≤
    ['click','keydown','mousemove','scroll'].forEach(ev=>document.addEventListener(ev, armIdle, {passive:true}));
    armIdle();
    function lockNow(){ $('#lockOverlay').style.display='flex'; }
    $('#lockUnlock')?.addEventListener('click', async ()=>{
      const sess=getSession(); if(!sess){ $('#lockOverlay').style.display='none'; return; }
      const pass=$('#lockPwd').value; const rec=getAccounts().find(x=>x.u===sess.u); if(!rec) return;
      const ok = (await sha256Hex(pass + rec.salt)) === rec.pwHash;
      if(ok){ $('#lockOverlay').style.display='none'; $('#lockPwd').value=''; armIdle(); }
      else { $('#lockMsg').textContent='–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å'; }
    });

    // ===== –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∏–∑–∞–π–Ω—É (–∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è/–ø—Ä–µ—Å–µ—Ç–∏/–∫–æ–Ω—Ç—Ä–∞—Å—Ç) =====
    const setCfg=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const getCfg=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}};
    function applyDesign(cfg){
      if(cfg.accent) document.documentElement.style.setProperty('--acc',cfg.accent);
      if(cfg.font) document.documentElement.style.setProperty('--fs',cfg.font+'px');
      if(cfg.density){const d=cfg.density==='compact'?0.9:(cfg.density==='comfortable'?1.15:1); document.documentElement.style.setProperty('--density',String(d));}
      const anim = cfg.animBg!==undefined ? cfg.animBg : true;
      document.body.classList.toggle('mw-anim-bg', !!anim);
      localStorage.setItem('mw_anim_bg', anim ? 'on' : 'off');
      if(cfg.shadowA!==undefined){
        document.documentElement.style.setProperty('--shadow-a', String(cfg.shadowA));
        localStorage.setItem('mw_shadow_a', String(cfg.shadowA));
      }
    }
    const cfg0=getCfg('mw_design_cfg',{accent:'#6a7dff',font:14,density:'normal',animBg:true,shadowA:parseFloat(localStorage.getItem('mw_shadow_a')||'0.1')});
    $('#dpAccent').value=cfg0.accent; $('#dpFont').value=String(cfg0.font); $('#dpDensity').value=cfg0.density; $('#dpAnimBg').value=cfg0.animBg?'on':'off'; $('#dpContrast').value=cfg0.shadowA;
    applyDesign(cfg0);
    $('#dpApply').addEventListener('click', ()=>{
      const cfg={accent:$('#dpAccent').value,font:Number($('#dpFont').value),density:$('#dpDensity').value,animBg:$('#dpAnimBg').value==='on',shadowA:parseFloat($('#dpContrast').value)};
      setCfg('mw_design_cfg',cfg); applyDesign(cfg); toast('–î–∏–∑–∞–π–Ω –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ');
    });
    $('#dpReset').addEventListener('click', ()=>{
      const def={accent:'#6a7dff',font:14,density:'normal',animBg:true,shadowA:0.1}; setCfg('mw_design_cfg',def); applyDesign(def); toast('–ü–æ–≤–µ—Ä–Ω—É—Ç–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º');
    });
    $('#presetDark').addEventListener('click', ()=>{document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); const c=getCfg('mw_design_cfg',cfg0); c.accent='#6a7dff'; c.animBg=true; setCfg('mw_design_cfg',c); applyDesign(c);});
    $('#presetLight').addEventListener('click', ()=>{document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); const c=getCfg('mw_design_cfg',cfg0); c.accent='#3b5bff'; c.animBg=false; setCfg('mw_design_cfg',c); applyDesign(c);});
    $('#presetMinecraft').addEventListener('click', ()=>{document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); const c=getCfg('mw_design_cfg',cfg0); c.accent='#6aa84f'; c.animBg=false; setCfg('mw_design_cfg',c); applyDesign(c);});

    // ===== –û–Ω–ª–∞–π–Ω-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è: –ª–∏—à–µ –æ—Å—Ç–∞–Ω–Ω—è –≤–µ—Ä—Å—ñ—è –∞–±–æ —Å—Ç–∞—Ç—É—Å "—É –≤–∞—Å –æ—Å—Ç–∞–Ω–Ω—è" =====
    const INDEX_HARD='https://nikobo101.github.io/milawebos-site/updates/index.json';
    const urlInput=$('#updIndexUrlSimple'); urlInput.value=localStorage.getItem('updatesIndexURL')||INDEX_HARD;
    urlInput.addEventListener('change',()=>localStorage.setItem('updatesIndexURL', urlInput.value.trim()));
    $('#btnCheckOnline')?.addEventListener('click',()=>$('#updCheck')?.click());
    const prog=(n)=>$('#updProg').style.width=n+'%';
    async function fetchIndex(){
      const url=(urlInput.value||'').trim(); if(!url){toast('–í–∫–∞–∂—ñ—Ç—å URL'); return null;}
      const r=await fetch(url,{cache:'no-store'}); if(!r.ok){toast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É'); return null;}
      return r.json();
    }
    $('#updCheck')?.addEventListener('click', async ()=>{
      const idx=await fetchIndex(); if(!idx) return; prog(60);
      const cur=document.querySelector('meta[name="app-version"]').content||'0';
      if(idx.latest && idx.latest>cur){
        $('#updResult').textContent='–î–æ—Å—Ç—É–ø–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è v'+idx.latest;
        $('#updInstallLatest').disabled=false;
      }else{
        $('#updResult').textContent='–£ –≤–∞—Å –æ—Å—Ç–∞–Ω–Ω—è –≤–µ—Ä—Å—ñ—è ('+cur+')';
        $('#updInstallLatest').disabled=true;
      }
      localStorage.setItem('mw_last_index', JSON.stringify(idx)); prog(100);
    });
    $('#updInstallLatest')?.addEventListener('click', async ()=>{
      const idx=JSON.parse(localStorage.getItem('mw_last_index')||'null'); if(!idx){toast('–°–ø–æ—á–∞—Ç–∫—É –ø–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è'); return;}
      const last=(idx.files||[]).find(x=>x.version===idx.latest); if(!last){toast('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –º–µ—Ç–∞–¥–∞–Ω—ñ'); return;}
      await installFromURL(last);
    });

    // –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª / –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ (–∑ —Ç—É–ª–±–∞—Ä–∞)
    let pickedText=null;
    $('#btnPickFile')?.addEventListener('click', async ()=>{
      try{
        const [h]=await showOpenFilePicker({types:[{description:'MILACRM update (*.mmur)', accept:{'application/json':['.mmur']}}]});
        const f=await h.getFile(); pickedText=await f.text();
        $('#btnInstallSel').disabled=false; toast('–§–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ');
      }catch(e){toast('–°–∫–∞—Å–æ–≤–∞–Ω–æ');}
    });
    $('#btnInstallSel')?.addEventListener('click', ()=>{
      try{ if(!pickedText){toast('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª'); return;}
        const mf=JSON.parse(pickedText); applyPatch(mf); toast('–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ v'+mf.version);
      }catch(e){ toast('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–∞–π–ª'); }
    });

    async function sha256Text(t){const d=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(t)); return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join('');}
    async function installFromURL(meta){
      try{
        prog(15); const r=await fetch(meta.url,{cache:'no-store'}); if(!r.ok){toast('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏'); prog(0); return;}
        const text=await r.text(); prog(65);
        if(meta.sha256 && meta.sha256.length>0){ const sum=await sha256Text(text); if(sum.toLowerCase()!==meta.sha256.toLowerCase()){toast('–•–µ—à –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è'); prog(0); return;} }
        const mf=JSON.parse(text); applyPatch(mf); prog(100); $('#updResult').textContent='–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ v'+mf.version;
      }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è'); prog(0); }
    }
    function applyPatch(mf){
      try{
        if(mf.patch?.css){ const s=document.createElement('style'); s.textContent=mf.patch.css; document.head.appendChild(s); }
        if(mf.patch?.js){ try{ (new Function(mf.patch.js))(); }catch(e){} }
        if(mf.patch?.title){ $('#appTitle').textContent=mf.patch.title; document.title=mf.patch.title; }
        if(mf.version){
          document.querySelector('meta[name="app-version"]').content=mf.version;
          $('#currentVersion').textContent='v'+mf.version; $('#verTxt').textContent='v'+mf.version;
        }
        const arr=load('appliedPatches',[]); arr.push({version:mf.version, patch:mf.patch}); save('appliedPatches',arr);
      }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è'); }
    }

    // ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è =====
    renderTable(); drawCharts(); renderAdmin(); uiGate();
    if(!localStorage.getItem('updatesIndexURL')) localStorage.setItem('updatesIndexURL', INDEX_HARD);
  })();
  </script>
</body>
</html>
