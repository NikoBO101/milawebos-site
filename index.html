<!doctype html>
<html lang="uk" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="app-version" content="3.0.0" />
  <title>MILACRM</title>

  <style>
    :root{
      --acc:#6a7dff; --btn:#273076; --btnH:#3a47a2; --btn2:#0f1530;
      --bg:#0f1426; --card:#141a33; --text:#e7ecff; --muted:#a9b3d9;
      --border:#262c4d; --input:#0f1530; --pill:#1a2140;
      --radius:14px; --fs:14px; --density:1;
    }
    [data-theme="light"]{
      --bg:#f6f8ff; --card:#ffffff; --text:#1b2340; --muted:#5a6590;
      --border:#d8def4; --input:#eef2ff; --pill:#eef2ff;
    }
    html,body{height:100%;font-size:var(--fs)}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .container{max-width:1100px;margin:18px auto;padding:0 14px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tabs button{border:1px solid var(--border);background:#161d3a;color:var(--text);border-radius:12px;padding:8px 12px;cursor:pointer}
    .tabs button.active{outline:2px solid var(--acc)}
    .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;background:#11183a;border:1px solid #2a356b;border-radius:14px;padding:8px 10px;margin-bottom:12px}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#7cff9f;box-shadow:0 0 0 4px rgba(124,255,159,.15)}
    .btn{border:1px solid #303a78;background:var(--btn);color:#e7ecff;border-radius:12px;padding:calc(8px*var(--density)) calc(12px*var(--density));cursor:pointer}
    .btn:hover{background:var(--btnH)}
    .btn-secondary{background:var(--btn2);border:1px solid #1c2350}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{display:none}.section.active{display:block}
    input,select,textarea{width:100%;background:var(--input);border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)}
    label{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}
    .muted{color:var(--muted);font-size:12px}
    #toast{position:fixed;right:16px;bottom:16px;background:#1a2140;border:1px solid var(--border);border-radius:10px;padding:8px 12px}
    .hidden{display:none!important}
    /* Animated gradient background (toggleable) */
    body.mw-anim-bg::before{content:"";position:fixed;inset:0;z-index:-1;
      background:linear-gradient(120deg,#0f1426,#1b244a,#273076,#0f1426);
      background-size:300% 300%;animation:mwShift 18s ease infinite;filter:saturate(1.05)}
    @keyframes mwShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    /* Kanban */
    #kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    #kanban .col{background:rgba(255,255,255,.03);border:1px solid #2a356b;border-radius:12px;padding:8px;min-height:180px}
    #kanban .cardx{background:#131a34;border:1px solid #2a356b;border-radius:12px;padding:8px;margin:6px 0;cursor:grab}
    /* Chips */
    #quickChips .chip{display:inline-block;background:#1a2140;border:1px solid #2a356b;border-radius:999px;padding:4px 8px;margin:2px 4px;color:#a9b3d9;font-size:12px;cursor:pointer}
    /* Progress */
    .progress{height:6px;background:#0f1530;border:1px solid #1c2350;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#4b64ff,#7a8cff)}
  </style>

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script id="applied-patches" type="application/json">{"applied":[]}</script>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="appTitle">MILACRM</h1>
      <span class="pill">–≤–µ—Ä—Å—ñ—è: <b id="currentVersion">v3.0.0</b></span>
      <div class="tabs">
        <button id="tabForm" class="active">–õ—ñ–¥–∏</button>
        <button id="tabSettings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        <button id="tabAdvanced">–†–æ–∑—à–∏—Ä–µ–Ω—ñ</button>
        <button id="tabAccount">–û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å</button>
        <button id="tabTraining">–ù–∞–≤—á–∞–Ω–Ω—è</button>
        <button id="themeToggleBtn">–¢–µ–º–∞</button>
      </div>
    </header>

    <!-- –í–µ—Ä—Ö–Ω—ñ–π —Ç—É–ª–±–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω—å -->
    <div class="topbar" id="mwTopbar">
      <span class="status-dot"></span><b>MILACRM</b>
      <span class="pill" id="currentVersionWrap">–≤–µ—Ä—Å—ñ—è: <b id="verTxt">v3.0.0</b></span>
      <span style="flex:1"></span>
      <button class="btn" id="btnCheckOnline">–ü–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
      <button class="btn" id="btnPickFile">–û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</button>
      <button class="btn btn-secondary" id="btnInstallSel" disabled>–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button>
      <button class="btn" id="btnGoTraining">–ù–∞–≤—á–∞–Ω–Ω—è</button>
    </div>

    <!-- –õ–Ü–î–ò -->
    <section id="formSection" class="section active">
      <div class="grid">
        <div class="card" id="crmOptionsCard">
          <h2>–û–ø—Ü—ñ—ó CRM</h2>
          <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="bulkInProgressBtn">–ú–∞—Å–æ–≤–æ: ¬´–í –æ–±—Ä–æ–±—Ü—ñ¬ª</button>
            <button class="btn btn-secondary" id="bulkDeleteBtn">üóë –ú–∞—Å–æ–≤–æ –≤–∏–¥–∞–ª–∏—Ç–∏</button>
            <button class="btn" id="expJsonBtn">‚¨á JSON</button>
            <button class="btn" id="expCsvBtn">‚¨á CSV</button>
            <button class="btn" id="seedDemo">–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –¥–µ–º–æ</button>
            <button class="btn" id="showLog">–ñ—É—Ä–Ω–∞–ª –¥—ñ–π</button>
            <button class="btn" id="checkDup">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏</button>
            <button class="btn" id="toggleCols">–ü–æ–ª—è —Ç–∞–±–ª–∏—Ü—ñ</button>
          </div>
        </div>
        <div class="card">
          <h2>–ü–æ—à—É–∫</h2>
          <input id="searchInput" placeholder="–ü–æ—à—É–∫ –ø–æ —ñ–º–µ–Ω—ñ/—Ç–µ–ª–µ—Ñ–æ–Ω—É/—Ç–µ–≥–∞—Ö/—Å—Ç–∞—Ç—É—Å—É" />
          <div id="quickChips" class="card" style="margin-top:10px">
            <h2>–®–≤–∏–¥–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏</h2>
            <span class="chip">–ù–æ–≤–∏–π</span>
            <span class="chip">–í –æ–±—Ä–æ–±—Ü—ñ</span>
            <span class="chip">–ó–∞–∫—Ä–∏—Ç–∏–π</span>
            <span class="chip">facebook</span>
            <span class="chip">email</span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>–ù–æ–≤–∏–π –ª—ñ–¥</h2>
        <form id="leadForm" class="grid">
          <div><label>–Ü–º º—è</label><input id="name" placeholder="–Ü–º º—è" /></div>
          <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="phone" placeholder="+380..." /></div>
          <div><label>Email</label><input id="email" type="email" placeholder="email@example.com" /></div>
          <div><label>–°—Ç–∞—Ç—É—Å</label>
            <select id="status"><option>–ù–æ–≤–∏–π</option><option>–í –æ–±—Ä–æ–±—Ü—ñ</option><option>–ó–∞–∫—Ä–∏—Ç–∏–π</option><option>–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π</option></select>
          </div>
          <div style="grid-column:1 / -1"><label>–¢–µ–≥–∏</label><input id="tags" placeholder="facebook, –≥–∞—Ä—è—á–∏–π" /></div>
          <div style="grid-column:1 / -1"><label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label><textarea id="comment" rows="3"></textarea></div>
          <div style="grid-column:1 / -1"><button class="btn" type="submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button></div>
        </form>
      </div>

      <div class="card table-wrap" style="margin-top:12px">
        <h2>–õ—ñ–¥–∏</h2>
        <table id="leadsTable">
          <thead>
          <tr><th></th><th>ID</th><th>–Ü–º º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>Email</th><th>–°—Ç–∞—Ç—É—Å</th><th>–¢–µ–≥–∏</th><th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th><th>–î—ñ—ó</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
    <section id="settingsSection" class="section">
      <div class="card" id="updatePanel">
        <h2>–û–Ω–æ–≤–ª–µ–Ω–Ω—è</h2>
        <div class="grid">
          <div>
            <label>URL —ñ–Ω–¥–µ–∫—Å—É</label>
            <input id="updIndexUrlSimple" placeholder="https://nikobo101.github.io/milawebos-site/updates/index.json">
          </div>
          <div style="display:flex;align-items:end;gap:8px">
            <button class="btn" id="updCheck">–ü–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
            <button class="btn btn-secondary" id="updInstallLatest" disabled>–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</button>
          </div>
        </div>
        <div class="progress" style="margin-top:8px"><i id="updProg"></i></div>
        <div id="updResult" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card" id="designPanel" style="margin-top:12px">
        <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∏–∑–∞–π–Ω—É</h2>
        <div class="grid">
          <div><label>–ê–∫—Ü–µ–Ω—Ç–Ω–∏–π –∫–æ–ª—ñ—Ä</label><input type="color" id="dpAccent" value="#6a7dff"></div>
          <div><label>–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É</label>
            <select id="dpFont"><option value="13">13</option><option value="14" selected>14</option><option value="15">15</option><option value="16">16</option></select>
          </div>
          <div><label>–©—ñ–ª—å–Ω—ñ—Å—Ç—å —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</label>
            <select id="dpDensity"><option value="compact">–ö–æ–º–ø–∞–∫—Ç–Ω–∞</option><option value="normal" selected>–ó–≤–∏—á–∞–π–Ω–∞</option><option value="comfortable">–ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞</option></select>
          </div>
          <div><label>–ê–Ω—ñ–º–æ–≤–∞–Ω–∏–π —Ñ–æ–Ω</label>
            <select id="dpAnimBg"><option value="on" selected>–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option><option value="off">–í–∏–º–∫–Ω–µ–Ω–æ</option></select>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="dpApply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          <button class="btn btn-secondary" id="dpReset">–°–∫–∏–Ω—É—Ç–∏</button>
          <button class="btn" id="presetDark">Dark</button>
          <button class="btn" id="presetLight">Light</button>
          <button class="btn" id="presetMinecraft">Minecraft</button>
        </div>
        <div class="muted" style="margin-top:6px">* –í–∏–º–∫–Ω–∏ –∞–Ω—ñ–º–æ–≤–∞–Ω–∏–π —Ñ–æ–Ω, —è–∫—â–æ –±—Ä–∞–∫—É—î –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>
      </div>
    </section>

    <!-- –†–û–ó–®–ò–†–ï–ù–Ü -->
    <section id="advancedFeaturesSection" class="section">
      <div class="grid">
        <div class="card">
          <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
          <canvas id="chartStatusPie" height="140"></canvas>
        </div>
        <div class="card">
          <h2>–î–∏–Ω–∞–º—ñ–∫–∞ –ø–æ –¥–Ω—è—Ö</h2>
          <canvas id="chartByDay" height="140"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>–ö–∞–Ω–±–∞–Ω</h2>
        <div id="kanban"></div>
      </div>

      <div class="grid" style="margin-top:12px" id="advOps">
        <div class="card" id="advArchive">
          <h2>–ê—Ä—Ö—ñ–≤</h2>
          <div class="muted">–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω—ñ –ª—ñ–¥–∏ –¥–æ –∞—Ä—Ö—ñ–≤—É –π –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –∞—Ä—Ö—ñ–≤.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn" id="toArchiveBtn">‚Üí –í –∞—Ä—Ö—ñ–≤</button>
            <button class="btn btn-secondary" id="viewArchiveBtn">–í—ñ–¥–∫—Ä–∏—Ç–∏ –∞—Ä—Ö—ñ–≤</button>
          </div>
        </div>
        <div class="card" id="advDup">
          <h2>–î—É–±–ª—ñ–∫–∞—Ç–∏</h2>
          <div class="muted">–ü–æ—à—É–∫ –ø–æ email/—Ç–µ–ª–µ—Ñ–æ–Ω—É —ñ –∑–ª–∏—Ç—Ç—è (—Ä—É—á–Ω–µ).</div>
          <button class="btn" id="findDupBtn" style="margin-top:6px">–ó–Ω–∞–π—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç–∏</button>
        </div>
        <div class="card" id="advCustomFields">
          <h2>–ö–∞—Å—Ç–æ–º–Ω—ñ –ø–æ–ª—è</h2>
          <div class="muted">–î–æ–¥–∞–≤–∞–π –≤–ª–∞—Å–Ω—ñ –ø–æ–ª—è –¥–æ —Ñ–æ—Ä–º–∏ –ª—ñ–¥a.</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="cfName" placeholder="–ù–∞–ø—Ä.: company">
            <button class="btn" id="addCFBtn">–î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ</button>
          </div>
        </div>
        <div class="card" id="helpCard">
          <h2>–ü—ñ–¥–∫–∞–∑–∫–∏</h2>
          <div class="muted">/ ‚Äî –ø–æ—à—É–∫, N ‚Äî –Ω–æ–≤–∏–π –ª—ñ–¥, Ctrl+S ‚Äî –∑–±–µ—Ä–µ–≥—Ç–∏, Shift+Del ‚Äî –º–∞—Å–æ–≤–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è</div>
        </div>
      </div>
    </section>

    <!-- –û–ë–õ–Ü–ö–û–í–ò–ô –ó–ê–ü–ò–° -->
    <section id="accountSection" class="section card">
      <h2>–û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å</h2>
      <div class="grid">
        <div><label>–õ–æ–≥—ñ–Ω</label><input id="accUser" placeholder="username"></div>
        <div><label>–ü–∞—Ä–æ–ª—å</label><input id="accPass" type="password" placeholder="–ø–∞—Ä–æ–ª—å"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="accCreate">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
        <button class="btn btn-secondary" id="accLogin">–£–≤—ñ–π—Ç–∏</button>
        <button class="btn btn-secondary" id="accLogout">–í–∏–π—Ç–∏</button>
      </div>
      <div id="accInfo" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- –ù–ê–í–ß–ê–ù–ù–Ø -->
    <section id="trainingSection" class="section card">
      <h2>–ù–∞–≤—á–∞–Ω–Ω—è MILACRM</h2>
      <div class="card step"><b>–ö—Ä–æ–∫ 1.</b> –î–æ–¥–∞–π—Ç–µ –ª—ñ–¥ —É –≤–∫–ª–∞–¥—Ü—ñ ¬´–õ—ñ–¥–∏¬ª. <div class="muted">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏¬ª.</div></div>
      <div class="card step"><b>–ö—Ä–æ–∫ 2.</b> –°–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—à—É–∫/—Ñ—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å ¬´–®–≤–∏–¥–∫–∏–π –ø–µ—Ä–µ–≥–ª—è–¥¬ª (—á—ñ–ø—Å–∏ –ø—ñ–¥ –ø–æ—à—É–∫–æ–º).</div>
      <div class="card step"><b>–ö—Ä–æ–∫ 3.</b> –í—ñ–¥–∫—Ä–∏–π—Ç–µ ¬´–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí –û–Ω–æ–≤–ª–µ–Ω–Ω—è¬ª —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è¬ª.</div>
      <div class="card step"><b>–ö—Ä–æ–∫ 4.</b> –ü–µ—Ä–µ–π–¥—ñ—Ç—å —É ¬´–†–æ–∑—à–∏—Ä–µ–Ω—ñ¬ª ‚Üí –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è –ö–∞–Ω–±–∞–Ω, –ê—Ä—Ö—ñ–≤, –î—É–±–ª—ñ–∫–∞—Ç–∏, –ï–∫—Å–ø–æ—Ä—Ç.</div>
    </section>
  </div>

  <div id="toast" class="hidden">OK</div>

  <script>
  (function(){
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));
    const toast=t=>{const el=$('#toast');el.textContent=t;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),2200);};

    // ===== –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ –≤–∫–ª–∞–¥–∫–∞—Ö =====
    const sections={tabForm:'formSection',tabSettings:'settingsSection',tabAdvanced:'advancedFeaturesSection',tabAccount:'accountSection',tabTraining:'trainingSection'};
    Object.keys(sections).forEach(id=>{
      const btn=$('#'+id);
      btn?.addEventListener('click',()=>{
        $$('.tabs button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        $$('.section').forEach(s=>s.classList.remove('active'));
        $('#'+sections[id])?.classList.add('active');
      });
    });
    $('#btnGoTraining')?.addEventListener('click',()=>{
      $$('#tabTraining')[0]?.click();
    });

    // ===== –¢–µ–º–∞ =====
    const themeBtn=$('#themeToggleBtn');
    const savedTheme=localStorage.getItem('theme')||'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.body.classList.toggle('mw-anim-bg', (localStorage.getItem('mw_anim_bg')||'on')==='on');
    themeBtn?.addEventListener('click', ()=>{
      const cur=document.documentElement.getAttribute('data-theme');
      const next=cur==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });

    // ===== SW (–æ—Ñ–ª–∞–π–Ω) =====
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

    // ===== –õ—ñ–¥–∏ CRUD =====
    const leadsKey='leads';
    const loadLeads=()=>{ try{return JSON.parse(localStorage.getItem(leadsKey)||'[]');}catch(e){return []} };
    const saveLeads=(a)=>localStorage.setItem(leadsKey, JSON.stringify(a));
    const renderTable=()=>{
      const q=($('#searchInput')?.value||'').trim().toLowerCase();
      const tb=$('#leadsTable tbody'); tb.innerHTML='';
      loadLeads().filter(l=>{
        const hay=[l.name,l.phone,l.email,l.status,l.tags].map(x=>(x||'').toLowerCase()).join('|');
        return !q || hay.includes(q);
      }).forEach(l=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="sel" data-id="${l.id}"></td>
          <td>${l.id}</td>
          <td>${l.name||''}</td>
          <td>${l.phone||''}</td>
          <td>${l.email||''}</td>
          <td>${l.status||''}</td>
          <td>${l.tags||''}</td>
          <td>${l.comment||''}</td>
          <td>
            <button class="btn btn-secondary editBtn" data-id="${l.id}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
            <button class="btn btn-secondary delBtn" data-id="${l.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </td>`;
        tb.appendChild(tr);
      });
    };
    window.renderTable=renderTable;

    $('#leadForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const leads=loadLeads();
      const id = Date.now();
      const get=v=>$('#'+v).value.trim();
      leads.push({
        id, name:get('name'), phone:get('phone'), email:get('email'),
        status:$('#status').value, tags:get('tags'), comment:get('comment'),
        date: new Date().toISOString(), updatedAt: new Date().toISOString()
      });
      saveLeads(leads); renderTable(); toast('–õ—ñ–¥ –¥–æ–¥–∞–Ω–æ'); e.target.reset();
    });

    // –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ / –í–∏–¥–∞–ª–∏—Ç–∏ / –ú–∞—Å–æ–≤–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    document.addEventListener('click',(e)=>{
      const editBtn=e.target.closest('.editBtn');
      const delBtn=e.target.closest('.delBtn');
      if(editBtn){
        const id=Number(editBtn.dataset.id);
        const a=loadLeads(); const i=a.findIndex(x=>x.id===id); if(i<0) return;
        const l=a[i];
        const name=prompt('–Ü–º º—è:', l.name||''); if(name===null) return;
        const phone=prompt('–¢–µ–ª–µ—Ñ–æ–Ω:', l.phone||''); if(phone===null) return;
        const email=prompt('Email:', l.email||''); if(email===null) return;
        const status=prompt('–°—Ç–∞—Ç—É—Å (–ù–æ–≤–∏–π/–í –æ–±—Ä–æ–±—Ü—ñ/–ó–∞–∫—Ä–∏—Ç–∏–π/–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π):', l.status||'–ù–æ–≤–∏–π'); if(status===null) return;
        const tags=prompt('–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É):', l.tags||''); if(tags===null) return;
        const comment=prompt('–ö–æ–º–µ–Ω—Ç–∞—Ä:', l.comment||''); if(comment===null) return;
        a[i]={...l,name,phone,email,status,tags,comment,updatedAt:new Date().toISOString()};
        saveLeads(a); renderTable(); toast('–ó–º—ñ–Ω–µ–Ω–æ'); return;
      }
      if(delBtn){
        const id=Number(delBtn.dataset.id);
        if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ª—ñ–¥ #' + id + '?')) return;
        let a=loadLeads(); a=a.filter(x=>x.id!==id); saveLeads(a); renderTable(); toast('–í–∏–¥–∞–ª–µ–Ω–æ'); return;
      }
    });
    $('#bulkDeleteBtn')?.addEventListener('click',()=>{
      const checked=$$('#leadsTable tbody .sel:checked'); if(!checked.length){toast('–ù–µ –æ–±—Ä–∞–Ω–æ'); return;}
      if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±—Ä–∞–Ω—ñ ('+checked.length+')?'))return;
      let a=loadLeads(); const ids=new Set(checked.map(cb=>Number(cb.dataset.id)));
      a=a.filter(x=>!ids.has(x.id)); saveLeads(a); renderTable(); toast('–í–∏–¥–∞–ª–µ–Ω–æ '+ids.size);
    });
    $('#bulkInProgressBtn')?.addEventListener('click', ()=>{
      const leads=loadLeads();
      $$('#leadsTable tbody .sel:checked').forEach(cb=>{
        const id=Number(cb.dataset.id); const i=leads.findIndex(l=>l.id===id);
        if(i>-1) leads[i].status='–í –æ–±—Ä–æ–±—Ü—ñ';
      });
      saveLeads(leads); renderTable(); toast('–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ');
    });
    $('#searchInput')?.addEventListener('input', renderTable);
    $('#quickChips')?.addEventListener('click', e=>{
      const tag=e.target.closest('.chip')?.textContent; if(!tag) return;
      $('#searchInput').value=tag; $('#searchInput').dispatchEvent(new Event('input'));
    });

    // –ï–∫—Å–ø–æ—Ä—Ç JSON/CSV
    $('#expJsonBtn')?.addEventListener('click',()=>{
      const data=JSON.stringify(loadLeads(),null,2);
      const url=URL.createObjectURL(new Blob([data],{type:'application/json'}));
      const a=document.createElement('a'); a.href=url; a.download='leads.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#expCsvBtn')?.addEventListener('click',()=>{
      const arr=loadLeads(); const head=['id','name','phone','email','status','tags','comment'];
      const rows=[head.join(',')].concat(arr.map(l=>head.map(k=>(''+(l[k]??'')).replace(/\"/g,'\"\"')).map(x=>`\"${x}\"`).join(',')));
      const csv=rows.join('\n');
      const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      const a=document.createElement('a'); a.href=url; a.download='leads.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // –î–µ–º–æ–¥–∞–Ω—ñ, –∂—É—Ä–Ω–∞–ª, –¥—É–±–ª—ñ–∫–∞—Ç–∏, –∫–æ–ª–æ–Ω–∫–∏
    let MW_LOG=[];
    window.mwLog=(m)=>{MW_LOG.push({t:Date.now(),m}); if(MW_LOG.length>100) MW_LOG.shift();};
    $('#seedDemo')?.addEventListener('click',()=>{
      const now=Date.now();
      const demo=[
        {id:now+1,name:'–Ü—Ä–∏–Ω–∞',phone:'+38000000001',email:'irina@example.com',status:'–ù–æ–≤–∏–π',tags:'facebook',comment:'—Ü—ñ–∫–∞–≤–∏–ª–∞—Å—å –¥–µ–º–æ',date:new Date().toISOString(),updatedAt:new Date().toISOString()},
        {id:now+2,name:'–û–ª–µ–≥',phone:'+38000000002',email:'oleg@example.com',status:'–í –æ–±—Ä–æ–±—Ü—ñ',tags:'email',comment:'–ø–æ—Ç—Ä—ñ–±–µ–Ω –ø—Ä–∞–π—Å',date:new Date().toISOString(),updatedAt:new Date().toISOString()}
      ];
      const a=loadLeads(); saveLeads(a.concat(demo)); renderTable(); toast('–î–µ–º–æ–¥–∞–Ω—ñ –¥–æ–¥–∞–Ω–æ');
    });
    $('#showLog')?.addEventListener('click',()=>{
      alert('–û—Å—Ç–∞–Ω–Ω—ñ –¥—ñ—ó:\n'+MW_LOG.slice(-10).map(x=>new Date(x.t).toLocaleTimeString('uk-UA')+' ‚Äî '+x.m).join('\n'));
    });
    $('#checkDup')?.addEventListener('click',()=>{
      const a=loadLeads(); const map=new Set();
      const dups=a.filter(l=>{const k=((l.email||'')+'|'+(l.phone||'')).toLowerCase(); if(map.has(k)) return true; map.add(k); return false;});
      alert('–î—É–±–ª—ñ–∫–∞—Ç—ñ–≤: '+dups.length);
    });
    $('#toggleCols')?.addEventListener('click',()=>{
      const labels=['Email','–¢–µ–≥–∏','–ö–æ–º–µ–Ω—Ç–∞—Ä'];
      labels.forEach(label=>{
        const th=[...$('#leadsTable thead tr').children].find(x=>x.textContent===label);
        if(!th) return; const idx=[...th.parentElement.children].indexOf(th);
        $$('#leadsTable tr').forEach(tr=>{ const td=tr.children[idx]; if(td) td.classList.toggle('hidden'); });
      });
    });

    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
    $('#email')?.addEventListener('input', e=>{
      const v=e.target.value.trim();
      const ok=/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)||v==='';
      e.target.classList.toggle('input-err',!ok);
    });
    $('#phone')?.addEventListener('input', e=>{
      const v=e.target.value.trim();
      const ok=/^[+0-9()\-\s]{6,}$/.test(v)||v==='';
      e.target.classList.toggle('input-err',!ok);
    });

    // –ö–∞–Ω–±–∞–Ω
    (function kanban(){
      const kb=$('#kanban'); if(!kb) return;
      const cols=['–ù–æ–≤–∏–π','–í –æ–±—Ä–æ–±—Ü—ñ','–ó–∞–∫—Ä–∏—Ç–∏–π','–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π'];
      cols.forEach(c=>{
        const col=document.createElement('div'); col.className='col'; col.dataset.status=c;
        col.innerHTML=`<h3>${c}</h3>`; col.ondragover=e=>e.preventDefault();
        col.ondrop=e=>{const id=e.dataTransfer.getData('text/plain'); move(Number(id),c); draw();};
        kb.appendChild(col);
      });
      const leads=()=>loadLeads();
      const save=v=>saveLeads(v);
      function move(id,status){const a=leads(); const i=a.findIndex(x=>x.id===id); if(i>-1){a[i].status=status; save(a); renderTable();}}
      function card(l){const d=document.createElement('div'); d.className='cardx'; d.draggable=true;
        d.ondragstart=e=>{e.dataTransfer.setData('text/plain', String(l.id));};
        d.innerHTML=`<b>${l.name||'–ë–µ–∑ –Ω–∞–∑–≤–∏'}</b><br><span class='muted'>${l.phone||''} ${l.email||''}</span>`;
        return d;
      }
      function draw(){
        $$('#kanban .col').forEach(c=>{
          c.querySelectorAll('.cardx').forEach(n=>n.remove());
          leads().filter(l=>l.status===c.dataset.status).forEach(l=>c.appendChild(card(l)));
        });
      }
      draw();
    })();

    // –ê—Ä—Ö—ñ–≤ / –î—É–±–ª—ñ–∫–∞—Ç–∏ / –ö–∞—Å—Ç–æ–º–Ω—ñ –ø–æ–ª—è
    const loadArch=()=>{ try{return JSON.parse(localStorage.getItem('leads_archive')||'[]')}catch(e){return []} };
    $('#toArchiveBtn')?.addEventListener('click',()=>{
      const ids=Array.from($$('#leadsTable tbody .sel:checked')).map(cb=>Number(cb.dataset.id));
      if(!ids.length){toast('–ù—ñ—á–æ–≥–æ –Ω–µ –æ–±—Ä–∞–Ω–æ');return;}
      let a=loadLeads(); const moving=a.filter(x=>ids.includes(x.id)); a=a.filter(x=>!ids.includes(x.id)); saveLeads(a);
      const arch=loadArch(); localStorage.setItem('leads_archive', JSON.stringify(arch.concat(moving)));
      renderTable(); toast('–í –∞—Ä—Ö—ñ–≤: '+moving.length);
    });
    $('#viewArchiveBtn')?.addEventListener('click',()=>{
      const arch=loadArch(); alert('–£ –∞—Ä—Ö—ñ–≤—ñ –∑–∞–ø–∏—Å—ñ–≤: '+arch.length);
    });
    $('#findDupBtn')?.addEventListener('click',()=>{
      const a=loadLeads();
      const key=(l)=> (l.email||'').toLowerCase()+'|'+(l.phone||'').replace(/\D/g,'');
      const map=new Map(); const dups=[];
      a.forEach(l=>{const k=key(l); if(map.has(k)) dups.push([map.get(k),l]); else map.set(k,l);});
      if(!dups.length){toast('–î—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');return;}
      alert('–ó–Ω–∞–π–¥–µ–Ω–æ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤: '+dups.length+' (–¥–∏–≤. –∫–æ–Ω—Å–æ–ª—å)'); console.log('DUPLICATES', dups);
    });
    $('#addCFBtn')?.addEventListener('click',()=>{
      const n=($('#cfName')?.value||'').trim(); if(!n){toast('–ù–∞–∑–≤–∞ –ø–æ–ª—è?');return;}
      const wrap=document.createElement('div'); wrap.style.gridColumn='1 / -1'; wrap.innerHTML=`<label>${n}</label><input id="cf_${n}">`;
      $('#leadForm')?.append(wrap); toast('–ü–æ–ª–µ –¥–æ–¥–∞–Ω–æ');
    });

    // –•–æ—Ç–∫–µ—ó
    document.addEventListener('keydown',e=>{
      if(e.key==='/' && !e.target.closest('input,textarea')){e.preventDefault(); $('#searchInput')?.focus();}
      if((e.key==='n'||e.key==='N') && !e.target.closest('input,textarea')){e.preventDefault(); $('#name')?.focus();}
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){e.preventDefault(); $('#leadForm')?.dispatchEvent(new Event('submit',{cancelable:true})); toast('–ó–±–µ—Ä–µ–∂–µ–Ω–æ');}
      if(e.shiftKey && e.key==='Delete'){ e.preventDefault(); $('#bulkDeleteBtn')?.click(); }
    });

    // –û–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å (–ª–æ–∫–∞–ª—å–Ω–∏–π)
    async function sha256(t){const d=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(t)); return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join('');}
    function setGateUI(isIn){ $('#settingsSection')?.classList.toggle('hidden',!isIn); $('#advancedFeaturesSection')?.classList.toggle('hidden',!isIn); }
    $('#accCreate')?.addEventListener('click', async ()=>{
      const u=$('#accUser').value.trim(); const p=$('#accPass').value; if(!u||!p){toast('–õ–æ–≥—ñ–Ω —ñ –ø–∞—Ä–æ–ª—å');return;}
      const salt=(Math.random().toString(36)+Date.now().toString(36)).slice(0,12);
      const hash=await sha256(p+salt);
      localStorage.setItem('acct', JSON.stringify({u,salt,hash}));
      localStorage.setItem('acct_session', JSON.stringify({u,ts:Date.now()}));
      $('#accInfo').textContent='–ê–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ —ñ —É–≤—ñ–π–¥–µ–Ω–æ'; setGateUI(true);
    });
    $('#accLogin')?.addEventListener('click', async ()=>{
      const rec=JSON.parse(localStorage.getItem('acct')||'null'); if(!rec){toast('–°–ø–µ—Ä—à—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç');return;}
      const u=$('#accUser').value.trim(); const p=$('#accPass').value; const hash=await sha256(p+rec.salt);
      if(rec.u===u && rec.hash===hash){ localStorage.setItem('acct_session', JSON.stringify({u,ts:Date.now()})); $('#accInfo').textContent='–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π'; setGateUI(true); }
      else $('#accInfo').textContent='–ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ';
    });
    $('#accLogout')?.addEventListener('click', ()=>{
      localStorage.removeItem('acct_session'); $('#accInfo').textContent='–í–∏—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ'; setGateUI(false);
    });
    setGateUI(!!localStorage.getItem('acct_session'));

    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∏–∑–∞–π–Ω—É
    const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const get=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}};
    function applyDesign(cfg){
      if(cfg.accent) document.documentElement.style.setProperty('--acc',cfg.accent);
      if(cfg.font) document.documentElement.style.setProperty('--fs',cfg.font+'px');
      if(cfg.density){const d=cfg.density==='compact'?0.9:(cfg.density==='comfortable'?1.15:1); document.documentElement.style.setProperty('--density',String(d));}
      const anim = cfg.animBg!==undefined ? cfg.animBg : true;
      document.body.classList.toggle('mw-anim-bg', !!anim);
      localStorage.setItem('mw_anim_bg', anim ? 'on' : 'off');
    }
    const cfg0=get('mw_design_cfg',{accent:'#6a7dff',font:14,density:'normal',animBg:true});
    $('#dpAccent').value=cfg0.accent; $('#dpFont').value=String(cfg0.font); $('#dpDensity').value=cfg0.density; $('#dpAnimBg').value=cfg0.animBg?'on':'off'; applyDesign(cfg0);
    $('#dpApply').addEventListener('click', ()=>{
      const cfg={accent:$('#dpAccent').value,font:Number($('#dpFont').value),density:$('#dpDensity').value,animBg:$('#dpAnimBg').value==='on'};
      set('mw_design_cfg',cfg); applyDesign(cfg); toast('–î–∏–∑–∞–π–Ω –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ');
    });
    $('#dpReset').addEventListener('click', ()=>{
      const def={accent:'#6a7dff',font:14,density:'normal',animBg:true}; set('mw_design_cfg',def); applyDesign(def); toast('–ü–æ–≤–µ—Ä–Ω—É—Ç–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º');
    });
    $('#presetDark').addEventListener('click', ()=>{document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); const c=get('mw_design_cfg',{accent:'#6a7dff',font:14,density:'normal',animBg:true}); c.accent='#6a7dff'; c.animBg=true; set('mw_design_cfg',c); applyDesign(c);});
    $('#presetLight').addEventListener('click', ()=>{document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); const c=get('mw_design_cfg',{accent:'#3b5bff',font:14,density:'normal',animBg:false}); c.accent='#3b5bff'; c.animBg=false; set('mw_design_cfg',c); applyDesign(c);});
    $('#presetMinecraft').addEventListener('click', ()=>{document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); const c=get('mw_design_cfg',{accent:'#6aa84f',font:14,density:'normal',animBg:false}); c.accent='#6aa84f'; c.animBg=false; set('mw_design_cfg',c); applyDesign(c);});

    // –û–Ω–ª–∞–π–Ω-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è (—Å–ø—Ä–æ—â–µ–Ω–µ, —ñ–∑ –≤–±—É–¥–æ–≤–∞–Ω–∏–º URL)
    const INDEX_HARD='https://nikobo101.github.io/milawebos-site/updates/index.json';
    const urlInput=$('#updIndexUrlSimple');
    urlInput.value=localStorage.getItem('updatesIndexURL')||INDEX_HARD;
    urlInput.addEventListener('change',()=>localStorage.setItem('updatesIndexURL', urlInput.value.trim()));
    $('#btnCheckOnline')?.addEventListener('click',()=>$('#updCheck')?.click());
    const prog=(n)=>$('#updProg').style.width=n+'%';
    async function sha256Text(t){const d=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(t)); return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join('');}
    async function fetchIndex(){
      const url=(urlInput.value||'').trim(); if(!url){toast('–í–∫–∞–∂—ñ—Ç—å URL'); return null;}
      const r=await fetch(url,{cache:'no-store'}); if(!r.ok){toast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É'); return null;}
      return r.json();
    }
    $('#updCheck')?.addEventListener('click', async ()=>{
      const idx=await fetchIndex(); if(!idx) return; prog(60);
      $('#updResult').textContent='–ó–Ω–∞–π–¥–µ–Ω–æ: –æ—Å—Ç–∞–Ω–Ω—è –≤–µ—Ä—Å—ñ—è v'+(idx.latest||'?'); $('#updInstallLatest').disabled=!idx.latest;
      localStorage.setItem('mw_last_index', JSON.stringify(idx)); prog(100);
    });
    $('#updInstallLatest')?.addEventListener('click', async ()=>{
      const idx=JSON.parse(localStorage.getItem('mw_last_index')||'null'); if(!idx){toast('–°–ø–æ—á–∞—Ç–∫—É –ø–æ—à—É–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è'); return;}
      const last=(idx.files||[]).find(x=>x.version===idx.latest); if(!last){toast('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –º–µ—Ç–∞–¥–∞–Ω—ñ'); return;}
      await installFromURL(last);
    });

    // –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª / –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ (–∑ —Ç—É–ª–±–∞—Ä–∞)
    let pickedText=null;
    $('#btnPickFile')?.addEventListener('click', async ()=>{
      try{
        const [h]=await showOpenFilePicker({types:[{description:'MILACRM update (*.mmur)', accept:{'application/json':['.mmur']}}]});
        const f=await h.getFile(); pickedText=await f.text();
        $('#btnInstallSel').disabled=false; toast('–§–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ');
      }catch(e){toast('–°–∫–∞—Å–æ–≤–∞–Ω–æ');}
    });
    $('#btnInstallSel')?.addEventListener('click', ()=>{
      try{ if(!pickedText){toast('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª'); return;}
        const mf=JSON.parse(pickedText); applyPatch(mf); toast('–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ v'+mf.version);
      }catch(e){ toast('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–∞–π–ª'); }
    });

    async function installFromURL(meta){
      try{
        prog(15); const r=await fetch(meta.url,{cache:'no-store'}); if(!r.ok){toast('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏'); prog(0); return;}
        const text=await r.text(); prog(65);
        if(meta.sha256 && meta.sha256.length>0){ const sum=await sha256Text(text); if(sum.toLowerCase()!==meta.sha256.toLowerCase()){toast('–•–µ—à –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è'); prog(0); return;} }
        const mf=JSON.parse(text); applyPatch(mf); prog(100); $('#updResult').textContent='–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ v'+mf.version;
      }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è'); prog(0); }
    }

    function applyPatch(mf){
      try{
        if(mf.patch?.css){ const s=document.createElement('style'); s.textContent=mf.patch.css; document.head.appendChild(s); }
        if(mf.patch?.js){ try{ (new Function(mf.patch.js))(); }catch(e){} }
        if(mf.patch?.title){ $('#appTitle').textContent=mf.patch.title; document.title=mf.patch.title; }
        if(mf.version){
          document.querySelector('meta[name="app-version"]').content=mf.version;
          $('#currentVersion').textContent = 'v'+mf.version; $('#verTxt').textContent='v'+mf.version;
        }
        const arr=JSON.parse(localStorage.getItem('appliedPatches')||'[]');
        arr.push({version:mf.version, patch:mf.patch});
        localStorage.setItem('appliedPatches', JSON.stringify(arr));
      }catch(e){ toast('–ü–æ–º–∏–ª–∫–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è'); }
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø—Ä–æ—Å—Ç–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è)
    function drawCharts(){
      try{
        const a=loadLeads(); const byStatus={'–ù–æ–≤–∏–π':0,'–í –æ–±—Ä–æ–±—Ü—ñ':0,'–ó–∞–∫—Ä–∏—Ç–∏–π':0,'–í—ñ–¥—Ö–∏–ª–µ–Ω–∏–π':0};
        a.forEach(l=>{ if(byStatus[l.status]!=null) byStatus[l.status]++; });
        const pie=new Chart(document.getElementById('chartStatusPie'),{
          type:'pie', data:{labels:Object.keys(byStatus), datasets:[{data:Object.values(byStatus)}]}, options:{plugins:{legend:{position:'bottom'}}}
        });
        const days={}; a.forEach(l=>{ const d=(l.date||'').slice(0,10); if(!d) return; days[d]=(days[d]||0)+1; });
        const line=new Chart(document.getElementById('chartByDay'),{
          type:'line', data:{labels:Object.keys(days), datasets:[{data:Object.values(days), tension:.3}]}, options:{plugins:{legend:{display:false}}}
        });
      }catch(e){}
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    renderTable(); drawCharts();

    // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî —è–∫—â–æ —ñ–Ω–¥–µ–∫—Å—É –Ω–µ–º–∞, –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î–º–æ –≤–±—É–¥–æ–≤–∞–Ω–∏–π
    if(!localStorage.getItem('updatesIndexURL')) localStorage.setItem('updatesIndexURL', INDEX_HARD);
  })();
  </script>
</body>
</html>
