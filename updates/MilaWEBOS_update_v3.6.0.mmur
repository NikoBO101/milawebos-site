{
  "type": "mila-update",
  "format": "mmur/v1",
  "version": "3.6.0",
  "date": "2025-11-04",
  "minAppVersion": "3.1.0",
  "mode": "patch-persist",
  "note": "Автотренажер: сам вводить/клікає/пояснює з підсвіткою та озвучкою; AI-помічник (BYO-AI або локальний). Дрібні покращення UI.",
  "patch": {
    "css": "/* === v3.6.0 Training Engine + AI Assistant === */.guide-fab{position:fixed;right:18px;bottom:86px;z-index:40;border:1px solid #3a47a2;background:#273076;color:#e7ecff;border-radius:14px;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}.teach-ol{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:42}.teach-ol.active{display:flex}.teach-box{max-width:520px;width:92%;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}.teach-spot{position:absolute;border:2px dashed #7cc8ff;border-radius:8px;pointer-events:none;z-index:43;display:none;box-shadow:0 0 0 6px rgba(124,200,255,.12)}.teach-spot.active{display:block}.teach-actions{display:flex;gap:8px;justify-content:space-between;margin-top:10px;align-items:center}.teach-actions .right{display:flex;gap:8px}.teach-bar{display:flex;gap:8px;align-items:center}.teach-bar input[type=range]{width:120px}.ai-panel{position:fixed;right:18px;bottom:156px;z-index:39;width:360px;max-width:92%;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;display:none}.ai-panel.active{display:block}.ai-head{display:flex;gap:8px;align-items:center;margin-bottom:8px}.ai-log{height:220px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px;background:rgba(255,255,255,.02)}.ai-log .msg{margin:4px 0}.ai-log .you{color:#9bf0c3}.ai-log .bot{color:#a9b3d9}.ai-row{display:flex;gap:6px;margin-top:8px}.ai-row input{flex:1}.ai-badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}.ai-badge.ok{color:#9bf0c3}.ai-badge.err{color:#ff8c8c}",
    "js": "(function(){const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));const sleep=ms=>new Promise(r=>setTimeout(r,ms));const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}catch(e){return d}};const toast=t=>{const el=$('#toast');if(!el)return;el.textContent=t;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),2200)};/* ========================= 0) Монтуємо FAB «Майстер» ========================= */(function ensureFab(){if($('#guideFab'))return;const b=document.createElement('button');b.id='guideFab';b.className='guide-fab';b.textContent='Майстер';document.body.appendChild(b);b.onclick=()=>window.MW_TRAIN?.open()})();/* ========================= 1) Тренажер: engine ========================= */(function trainingEngine(){if(window.MW_TRAIN) return;const overlay=document.createElement('div');overlay.className='teach-ol';overlay.innerHTML=`<div class='teach-box'><h3 id='teachTitle'>Навчання</h3><div id='teachText' class='muted'>Готові? Я все покажу і зроблю.</div><div class='teach-actions'><div class='teach-bar'><label>Швидкість</label><input id='teachSpeed' type='range' min='0.5' max='2' step='0.1' value='1'><label><input id='teachVoice' type='checkbox'> Озвучувати</label></div><div class='right'><button class='btn btn-secondary' id='teachClose'>Закрити</button><button class='btn' id='teachStart'>Старт</button></div></div></div>`;document.body.appendChild(overlay);const spot=document.createElement('div');spot.className='teach-spot';document.body.appendChild(spot);let running=false, speed=1, voice=false;const speak=(txt)=>{if(!voice) return;try{const u=new SpeechSynthesisUtterance(txt);u.lang=(localStorage.getItem('mw_lang')||'uk')==='en'?'en-US':'uk-UA';speechSynthesis.cancel();speechSynthesis.speak(u)}catch{}};function place(el){if(!el){spot.classList.remove('active');return}const r=el.getBoundingClientRect();spot.style.left=(r.left-6)+'px';spot.style.top=(r.top-6)+'px';spot.style.width=(r.width+12)+'px';spot.style.height=(r.height+12)+'px';spot.classList.add('active');el.scrollIntoView({block:'center',behavior:'smooth'})}async function typeInto(el,text){el.focus();el.value='';for(const ch of text){el.value+=ch;el.dispatchEvent(new Event('input'));await sleep(35/speed)}await sleep(120/speed)}async function click(el){el.click();await sleep(250/speed)}function toTab(btnId){$('#'+btnId)?.click()}const stepsBasic=[{say:'Додамо новий лід.', run:async()=>{toTab('tabForm');const name=$('#name');place(name);await typeInto(name,'Приклад Клієнт')}},{say:'Телефон у міжнародному форматі.', run:async()=>{const el=$('#phone');place(el);await typeInto(el,'+380931112233')}},{say:'Email — за бажанням.', run:async()=>{const el=$('#email');place(el);await typeInto(el,'client@example.com')}},{say:'Виберемо статус «Новий».', run:async()=>{const el=$('#status');place(el);el.value='Новий';el.dispatchEvent(new Event('change'));await sleep(250/speed)}},{say:'Додамо теги через кому.', run:async()=>{const el=$('#tags');place(el);await typeInto(el,'facebook, гарячий')}},{say:'Коротка нотатка.', run:async()=>{const el=$('#comment');place(el);await typeInto(el,'Попросив прайс і знижку')}},{say:'Зберігаємо лід.', run:async()=>{const el=$('#leadForm button[type=\"submit\"]');place(el);await click(el)}},{say:'Перевіримо пошук за тегом.', run:async()=>{const el=$('#searchInput');place(el);await typeInto(el,'facebook')}},{say:'Покажу швидкі опції CRM.', run:async()=>{const btn=$('#crmDropBtn');toTab('tabForm');place(btn);await click(btn)}},{say:'Тепер подивимось Оновлення — лише остання версія.', run:async()=>{toTab('tabSettings');const b=$('#updCheck');place(b);await click(b)}}];const stepsExtended=[{say:'Перейдемо до Онлайн-сховища.', run:async()=>{toTab('tabSettings');const el=$('#cloudCard');place(el);await sleep(600/speed)}},{say:'Якщо налаштовано GitHub Gist — можна вивантажити зашифровані дані.', run:async()=>{const el=$('#csPush');place(el);await sleep(600/speed)}}];async function runScenario(list){for(const st of list){if(!running) break;$('#teachText').textContent=st.say;speak(st.say);await st.run()}$('#teachText').textContent=running?'Готово!':'Зупинено.';speak('Готово');running=false;spot.classList.remove('active')}const api={open(){overlay.classList.add('active')},close(){overlay.classList.remove('active');spot.classList.remove('active');running=false},start(){running=true;speed=parseFloat($('#teachSpeed').value||'1');voice=$('#teachVoice').checked;runScenario([].concat(stepsBasic,stepsExtended))},stop(){running=false}};$('#teachStart').onclick=()=>api.start();$('#teachClose').onclick=()=>api.close();$('#teachSpeed').onchange=()=>{speed=parseFloat($('#teachSpeed').value||'1')};$('#teachVoice').onchange=()=>{voice=$('#teachVoice').checked};window.MW_TRAIN=api;/* дублери для старих кнопок */$('#tabTraining')?.addEventListener('click',e=>{e.preventDefault();api.open()});$('#btnGoTraining')?.addEventListener('click',e=>{e.preventDefault();api.open()});})();/* ========================= 2) AI-помічник ========================= */(function aiAssistant(){if($('#aiPanel')) return;const panel=document.createElement('div');panel.id='aiPanel';panel.className='ai-panel';panel.innerHTML=`<div class='ai-head'><b>AI Assistant</b><span id='aiState' class='ai-badge'>offline</span><span style='flex:1'></span><button class='btn btn-secondary' id='aiClose'>✕</button></div><div class='ai-log' id='aiLog'></div><div class='ai-row'><input id='aiInput' placeholder='Запитайте про ліди, пошук, інструкції...'><button class='btn' id='aiSend'>Надіслати</button></div>`;document.body.appendChild(panel);const fab=$('#guideFab');if(fab){const btn=document.createElement('button');btn.className='btn';btn.style.marginLeft='8px';btn.textContent='AI';btn.onclick=()=>panel.classList.toggle('active');fab.parentElement.insertBefore(btn,fab.nextSibling)};$('#aiClose').onclick=()=>panel.classList.remove('active');function log(role, text){const box=$('#aiLog');const div=document.createElement('div');div.className='msg '+(role==='you'?'you':'bot');div.textContent=(role==='you'?'You: ':'AI: ')+text;box.appendChild(div);box.scrollTop=box.scrollHeight}const cfgKey='mw_ai_cfg';/* налаштування у Settings (карточка) */(function mountCfg(){const host=$('#settingsSection');if(!host||$('#aiCfgCard'))return;const card=document.createElement('div');card.id='aiCfgCard';card.className='card';card.style.marginTop='12px';card.innerHTML=`<h2>AI Assistant (BYO)</h2><div class='grid'><div><label>Endpoint URL</label><input id='aiUrl' placeholder='https://api.example.com/chat'></div><div><label>Bearer Token</label><input id='aiTok' placeholder='sk-...'></div><div><label>Model (опц.)</label><input id='aiModel' placeholder='gpt-4o-mini'></div><div><label>Активувати</label><select id='aiOn'><option value='off'>Off</option><option value='on'>On</option></select></div></div><div class='muted' style='margin-top:6px'>* Якщо вимкнено — працює локальний хелпер без інтернету.</div>`;host.appendChild(card);const c=load(cfgKey,{});$('#aiUrl').value=c.url||'';$('#aiTok').value=c.tok||'';$('#aiModel').value=c.model||'';$('#aiOn').value=c.on||'off';function saveCfg(){save(cfgKey,{url:$('#aiUrl').value.trim(),tok:$('#aiTok').value.trim(),model:$('#aiModel').value.trim(),on:$('#aiOn').value})}['aiUrl','aiTok','aiModel','aiOn'].forEach(id=>$('#'+id).addEventListener('change',saveCfg));updateState();})();function updateState(){const c=load(cfgKey,{});const online = c.on==='on' && c.url && c.tok;$('#aiState').textContent = online?'online':'offline';$('#aiState').className='ai-badge '+(online?'ok':'err')}async function askRemote(q){const c=load(cfgKey,{});const body = c.model? {model:c.model,messages:[{role:'user',content:q}],temperature:0.3} : {messages:[{role:'user',content:q}]};const r= await fetch(c.url,{method:'POST',headers:{'content-type':'application/json','authorization':'Bearer '+c.tok},body:JSON.stringify(body)});if(!r.ok) throw new Error('HTTP '+r.status);const j=await r.json();const txt = j.choices?.[0]?.message?.content || j.reply || JSON.stringify(j);return txt}function answerLocal(q){q=q.toLowerCase();const leads=load('leads',[]);if(/скільки|how many|count/.test(q)){return 'У базі лідiв: '+leads.length;}if(/покажи.*(нов|new)/.test(q)){const n=leads.filter(l=>l.status==='Новий').slice(0,5).map(l=>l.name||l.email||l.phone).join(', ')||'нема';return 'Нові (перші 5): '+n;}if(/дубл|duplicate/.test(q)){const set=new Set();const d=leads.filter(l=>{const k=((l.email||'')+'|'+(l.phone||'')).toLowerCase();if(set.has(k)) return true; set.add(k); return false});return 'Дублікатів знайдено: '+d.length;}return 'Локальний помічник: спробуйте «Скільки лідів», «Покажи нові», «Дублікатів скільки». Або ввімкніть BYO-AI у Налаштуваннях → AI Assistant.'}$('#aiSend').onclick=async()=>{const q=($('#aiInput').value||'').trim();if(!q) return;$('#aiInput').value='';log('you',q);try{const c=load(cfgKey,{});const online=c.on==='on' && c.url && c.tok;let a='';if(online){a=await askRemote(q)}else{a=answerLocal(q)}log('bot',a)}catch(e){log('bot','Помилка: '+e.message)}};updateState();})();})();"
  }
}
